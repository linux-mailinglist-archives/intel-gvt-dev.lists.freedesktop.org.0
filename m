Return-Path: <intel-gvt-dev-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gvt-dev@lfdr.de
Delivered-To: lists+intel-gvt-dev@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 7694B618F4
	for <lists+intel-gvt-dev@lfdr.de>; Mon,  8 Jul 2019 03:35:54 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 28330899F2;
	Mon,  8 Jul 2019 01:35:53 +0000 (UTC)
X-Original-To: intel-gvt-dev@lists.freedesktop.org
Delivered-To: intel-gvt-dev@lists.freedesktop.org
Received: from mga04.intel.com (mga04.intel.com [192.55.52.120])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 4222B899DB;
 Mon,  8 Jul 2019 01:35:52 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from fmsmga003.fm.intel.com ([10.253.24.29])
 by fmsmga104.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 07 Jul 2019 18:35:52 -0700
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.63,464,1557212400"; d="scan'208";a="173131322"
Received: from xzhan34-mobl3.bj.intel.com ([10.238.154.53])
 by FMSMGA003.fm.intel.com with ESMTP; 07 Jul 2019 18:35:51 -0700
From: Xiaolin Zhang <xiaolin.zhang@intel.com>
To: intel-gfx@lists.freedesktop.org
Subject: [PATCH v7 9/9] drm/i915/gvt: GVTg support context submission pv
 optimization
Date: Mon,  8 Jul 2019 09:35:22 +0800
Message-Id: <1562549722-27046-10-git-send-email-xiaolin.zhang@intel.com>
X-Mailer: git-send-email 2.7.4
In-Reply-To: <1562549722-27046-1-git-send-email-xiaolin.zhang@intel.com>
References: <1562549722-27046-1-git-send-email-xiaolin.zhang@intel.com>
X-BeenThere: intel-gvt-dev@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: "Intel GVT \(Graphics Virtualization\) development list"
 <intel-gvt-dev.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gvt-dev>, 
 <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gvt-dev>
List-Post: <mailto:intel-gvt-dev@lists.freedesktop.org>
List-Help: <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gvt-dev>, 
 <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=subscribe>
Cc: Xiaolin Zhang <xiaolin.zhang@intel.com>,
 intel-gvt-dev@lists.freedesktop.org
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gvt-dev-bounces@lists.freedesktop.org
Sender: "intel-gvt-dev" <intel-gvt-dev-bounces@lists.freedesktop.org>

aW1wbGVtZW50ZWQgY29udGV4dCBzdWJtaXNzaW9uIHB2IG9wdGltaXphaXRvbiB3aXRoaW4gR1ZU
Zy4KCkdWVGcgdG8gcmVhZCBjb250ZXh0IHN1Ym1pc3Npb24gZGF0YSAoZWxzcF9kYXRhKSBmcm9t
IHRoZSBzaGFyZWRfcGFnZQpkaXJlY3RseSB3aXRob3V0IHRyYXAgY29zdCBhbmQgZWxpbWluYXRl
IGV4ZWNsaXN0IEhXIGJlaGF2aW9yIGVtdWxhdGlvbgp3aXRob3V0IGluamVjdGluZyBjb250ZXh0
IHN3aXRjaCBpbnRlcnJ1cHQgdG8gZ3Vlc3QgdW5kZXIgUFYKc3VibWlzaXNvbiBtZWNoYW5pc20u
Cgp2MDogUkZDLgp2MTogcmViYXNlLgp2MjogcmViYXNlLgp2MzogcmVwb3J0IHB2IGNvbnRleHQg
c3VibWlzc2lvbiBjYXAgYW5kIGhhbmRsZSBWR1RfRzJWX0VMU1BfU1VCTUlUCmcydiBwdiBub3Rp
ZmljYXRpb24uCnY0OiBlbGltaW5hdGUgZXhlY2xpc3QgSFcgZW11bGF0aW9uIGFuZCBkb24ndCBp
bmplY3QgY29udGV4dCBzd2l0Y2gKaW50ZXJydXB0IHRvIGd1ZXN0IHVuZGVyIFBWIHN1Ym1pc2lz
b24gbWVjaGFuaXNtLgp2NTogcmViYXNlLgp2NjogcmViYXNlLgp2NzogcmViYXNlLgoKU2lnbmVk
LW9mZi1ieTogWGlhb2xpbiBaaGFuZyA8eGlhb2xpbi56aGFuZ0BpbnRlbC5jb20+Ci0tLQogZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ3Z0L2V4ZWNsaXN0LmMgfCAgNiArKysrKysKIGRyaXZlcnMvZ3B1
L2RybS9pOTE1L2d2dC9oYW5kbGVycy5jIHwgMzAgKysrKysrKysrKysrKysrKysrKysrKysrKysr
KystCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQvdmdwdS5jICAgICB8ICAyICsrCiAzIGZpbGVz
IGNoYW5nZWQsIDM3IGluc2VydGlvbnMoKyksIDEgZGVsZXRpb24oLSkKCmRpZmYgLS1naXQgYS9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQvZXhlY2xpc3QuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2d2dC9leGVjbGlzdC5jCmluZGV4IGYyMWI4ZmIuLmU1MmJmZDYgMTAwNjQ0Ci0tLSBhL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2d2dC9leGVjbGlzdC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2d2dC9leGVjbGlzdC5jCkBAIC0zODIsNiArMzgyLDkgQEAgc3RhdGljIGludCBwcmVwYXJlX2V4
ZWNsaXN0X3dvcmtsb2FkKHN0cnVjdCBpbnRlbF92Z3B1X3dvcmtsb2FkICp3b3JrbG9hZCkKIAlp
bnQgcmluZ19pZCA9IHdvcmtsb2FkLT5yaW5nX2lkOwogCWludCByZXQ7CiAKKwlpZiAoVkdQVV9Q
VkNBUCh2Z3B1LCBQVl9TVUJNSVNTSU9OKSkKKwkJcmV0dXJuIDA7CisKIAlpZiAoIXdvcmtsb2Fk
LT5lbXVsYXRlX3NjaGVkdWxlX2luKQogCQlyZXR1cm4gMDsKIApAQCAtNDI5LDYgKzQzMiw5IEBA
IHN0YXRpYyBpbnQgY29tcGxldGVfZXhlY2xpc3Rfd29ya2xvYWQoc3RydWN0IGludGVsX3ZncHVf
d29ya2xvYWQgKndvcmtsb2FkKQogCQlnb3RvIG91dDsKIAl9CiAKKwlpZiAoVkdQVV9QVkNBUCh2
Z3B1LCBQVl9TVUJNSVNTSU9OKSkKKwkJZ290byBvdXQ7CisKIAlyZXQgPSBlbXVsYXRlX2V4ZWNs
aXN0X2N0eF9zY2hlZHVsZV9vdXQoZXhlY2xpc3QsICZ3b3JrbG9hZC0+Y3R4X2Rlc2MpOwogb3V0
OgogCWludGVsX3ZncHVfdW5waW5fbW0od29ya2xvYWQtPnNoYWRvd19tbSk7CmRpZmYgLS1naXQg
YS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQvaGFuZGxlcnMuYyBiL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2d2dC9oYW5kbGVycy5jCmluZGV4IDg1YjQzNDYuLjdkYTY3MDAgMTAwNjQ0Ci0tLSBhL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2d2dC9oYW5kbGVycy5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2d2dC9oYW5kbGVycy5jCkBAIC0xODEwLDYgKzE4MTAsMzEgQEAgc3RhdGljIGludCBtbWlv
X3JlYWRfZnJvbV9odyhzdHJ1Y3QgaW50ZWxfdmdwdSAqdmdwdSwKIAlyZXR1cm4gaW50ZWxfdmdw
dV9kZWZhdWx0X21taW9fcmVhZCh2Z3B1LCBvZmZzZXQsIHBfZGF0YSwgYnl0ZXMpOwogfQogCitz
dGF0aWMgaW50IGhhbmRsZV9wdl9zdWJtaXNzaW9uKHN0cnVjdCBpbnRlbF92Z3B1ICp2Z3B1LCBp
bnQgcmluZ19pZCkKK3sKKwlzdHJ1Y3QgaW50ZWxfdmdwdV9leGVjbGlzdCAqZXhlY2xpc3Q7CisJ
dTMyIGh3X2lkID0gdmdwdS0+Z3Z0LT5kZXZfcHJpdi0+ZW5naW5lW3JpbmdfaWRdLT5od19pZDsK
Kwl1MzIgYmFzZSA9IFBWX0VMU1BfT0ZGICsgaHdfaWQgKiBzaXplb2Yoc3RydWN0IHB2X3N1Ym1p
c3Npb24pOworCXUzMiBkZXNjX29mZiA9IG9mZnNldG9mKHN0cnVjdCBwdl9zdWJtaXNzaW9uLCBk
ZXNjcyk7CisJdTMyIHN1Ym1pdHRlZF9vZmYgPSBvZmZzZXRvZihzdHJ1Y3QgcHZfc3VibWlzc2lv
biwgc3VibWl0dGVkKTsKKwlib29sIHN1Ym1pdHRlZCA9IHRydWU7CisJaW50IHJldDsKKworCWV4
ZWNsaXN0ID0gJnZncHUtPnN1Ym1pc3Npb24uZXhlY2xpc3RbcmluZ19pZF07CisJZGVzY19vZmYg
Kz0gYmFzZTsKKwlpZiAoaW50ZWxfZ3Z0X3JlYWRfc2hhcmVkX3BhZ2UodmdwdSwgZGVzY19vZmYs
CisJCQkmZXhlY2xpc3QtPmVsc3BfZHdvcmRzLmRhdGEsIDE2KSkKKwkJcmV0dXJuIC1FSU5WQUw7
CisKKwlyZXQgPSBpbnRlbF92Z3B1X3N1Ym1pdF9leGVjbGlzdCh2Z3B1LCByaW5nX2lkKTsKKwlp
ZiAocmV0KQorCQlzdWJtaXR0ZWQgPSBmYWxzZTsKKworCXN1Ym1pdHRlZF9vZmYgKz0gYmFzZTsK
KwlyZXQgPSBpbnRlbF9ndnRfd3JpdGVfc2hhcmVkX3BhZ2UodmdwdSwgc3VibWl0dGVkX29mZiwg
JnN1Ym1pdHRlZCwgMSk7CisJcmV0dXJuIHJldDsKK30KKwogc3RhdGljIGludCBlbHNwX21taW9f
d3JpdGUoc3RydWN0IGludGVsX3ZncHUgKnZncHUsIHVuc2lnbmVkIGludCBvZmZzZXQsCiAJCXZv
aWQgKnBfZGF0YSwgdW5zaWduZWQgaW50IGJ5dGVzKQogewpAQCAtMTgyMSw4ICsxODQ2LDExIEBA
IHN0YXRpYyBpbnQgZWxzcF9tbWlvX3dyaXRlKHN0cnVjdCBpbnRlbF92Z3B1ICp2Z3B1LCB1bnNp
Z25lZCBpbnQgb2Zmc2V0LAogCWlmIChXQVJOX09OKHJpbmdfaWQgPCAwIHx8IHJpbmdfaWQgPj0g
STkxNV9OVU1fRU5HSU5FUykpCiAJCXJldHVybiAtRUlOVkFMOwogCi0JZXhlY2xpc3QgPSAmdmdw
dS0+c3VibWlzc2lvbi5leGVjbGlzdFtyaW5nX2lkXTsKKwlpZiAoVkdQVV9QVkNBUCh2Z3B1LCBQ
Vl9TVUJNSVNTSU9OKSAmJgorCQkJZGF0YSA9PSBQVl9BQ1RJT05fRUxTUF9TVUJNSVNTSU9OKQor
CQlyZXR1cm4gaGFuZGxlX3B2X3N1Ym1pc3Npb24odmdwdSwgcmluZ19pZCk7CiAKKwlleGVjbGlz
dCA9ICZ2Z3B1LT5zdWJtaXNzaW9uLmV4ZWNsaXN0W3JpbmdfaWRdOwogCWV4ZWNsaXN0LT5lbHNw
X2R3b3Jkcy5kYXRhWzMgLSBleGVjbGlzdC0+ZWxzcF9kd29yZHMuaW5kZXhdID0gZGF0YTsKIAlp
ZiAoZXhlY2xpc3QtPmVsc3BfZHdvcmRzLmluZGV4ID09IDMpIHsKIAkJcmV0ID0gaW50ZWxfdmdw
dV9zdWJtaXRfZXhlY2xpc3QodmdwdSwgcmluZ19pZCk7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9ndnQvdmdwdS5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Z0L3ZncHUuYwpp
bmRleCBmOTgyYTIzLi5jYjA4OGEwIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9n
dnQvdmdwdS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d2dC92Z3B1LmMKQEAgLTUxLDYg
KzUxLDggQEAgdm9pZCBwb3B1bGF0ZV9wdmluZm9fcGFnZShzdHJ1Y3QgaW50ZWxfdmdwdSAqdmdw
dSkKIAogCWlmICghaW50ZWxfdnRkX2FjdGl2ZSgpKQogCQl2Z3B1X3ZyZWdfdCh2Z3B1LCB2Z3Rp
Zl9yZWcocHZfY2FwcykpID0gUFZfUFBHVFRfVVBEQVRFOworCXZncHVfdnJlZ190KHZncHUsIHZn
dGlmX3JlZyhwdl9jYXBzKSkgfD0gUFZfU1VCTUlTU0lPTjsKKwogCXZncHVfdnJlZ190KHZncHUs
IHZndGlmX3JlZyhhdmFpbF9ycy5tYXBwYWJsZV9nbWFkci5iYXNlKSkgPQogCQl2Z3B1X2FwZXJ0
dXJlX2dtYWRyX2Jhc2UodmdwdSk7CiAJdmdwdV92cmVnX3QodmdwdSwgdmd0aWZfcmVnKGF2YWls
X3JzLm1hcHBhYmxlX2dtYWRyLnNpemUpKSA9Ci0tIAoyLjcuNAoKX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX18KaW50ZWwtZ3Z0LWRldiBtYWlsaW5nIGxpc3QK
aW50ZWwtZ3Z0LWRldkBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVz
a3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9pbnRlbC1ndnQtZGV2
