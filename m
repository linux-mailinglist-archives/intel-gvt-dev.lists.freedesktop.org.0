Return-Path: <intel-gvt-dev-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gvt-dev@lfdr.de
Delivered-To: lists+intel-gvt-dev@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 83C8E57A23
	for <lists+intel-gvt-dev@lfdr.de>; Thu, 27 Jun 2019 05:44:13 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 3FE946E59B;
	Thu, 27 Jun 2019 03:44:12 +0000 (UTC)
X-Original-To: intel-gvt-dev@lists.freedesktop.org
Delivered-To: intel-gvt-dev@lists.freedesktop.org
Received: from mga03.intel.com (mga03.intel.com [134.134.136.65])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 3EF9E6E59B
 for <intel-gvt-dev@lists.freedesktop.org>;
 Thu, 27 Jun 2019 03:44:11 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from fmsmga005.fm.intel.com ([10.253.24.32])
 by orsmga103.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 26 Jun 2019 20:44:10 -0700
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.63,422,1557212400"; d="scan'208";a="360561007"
Received: from gvt.bj.intel.com ([10.238.158.187])
 by fmsmga005.fm.intel.com with ESMTP; 26 Jun 2019 20:44:08 -0700
From: Tina Zhang <tina.zhang@intel.com>
To: intel-gvt-dev@lists.freedesktop.org, kvm@vger.kernel.org,
 linux-kernel@vger.kernel.org
Subject: [RFC PATCH v3 4/4] drm/i915/gvt: Deliver vGPU vblank event to
 userspace
Date: Thu, 27 Jun 2019 11:38:02 +0800
Message-Id: <20190627033802.1663-5-tina.zhang@intel.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20190627033802.1663-1-tina.zhang@intel.com>
References: <20190627033802.1663-1-tina.zhang@intel.com>
X-BeenThere: intel-gvt-dev@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: "Intel GVT \(Graphics Virtualization\) development list"
 <intel-gvt-dev.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gvt-dev>, 
 <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gvt-dev>
List-Post: <mailto:intel-gvt-dev@lists.freedesktop.org>
List-Help: <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gvt-dev>, 
 <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=subscribe>
Cc: kevin.tian@intel.com, zhenyuw@linux.intel.com,
 Tina Zhang <tina.zhang@intel.com>, alex.williamson@redhat.com,
 zhiyuan.lv@intel.com, hang.yuan@intel.com, zhi.a.wang@intel.com,
 kraxel@redhat.com
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gvt-dev-bounces@lists.freedesktop.org
Sender: "intel-gvt-dev" <intel-gvt-dev-bounces@lists.freedesktop.org>

RGVsaXZlciB0aGUgZGlzcGxheSB2YmxhbmsgZXZlbnQgdG8gdGhlIHVzZXIgbGFuZC4gVXNlcnNw
YWNlIGNhbiB1c2UKdGhlIGlycSBtYXNrL3VubWFzayBtZWNoYW5pc20gdG8gZGlzYWJsZSBvciBl
bmFibGUgdGhlIGV2ZW50IGRlbGl2ZXJ5LgoKU2lnbmVkLW9mZi1ieTogVGluYSBaaGFuZyA8dGlu
YS56aGFuZ0BpbnRlbC5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Z0L2Rpc3BsYXku
YyB8ICAgNCArCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQvZ3Z0LmggICAgIHwgICA0ICsKIGRy
aXZlcnMvZ3B1L2RybS9pOTE1L2d2dC9rdm1ndC5jICAgfCAxNTAgKysrKysrKysrKysrKysrKysr
KysrKysrKysrLS0KIDMgZmlsZXMgY2hhbmdlZCwgMTQ5IGluc2VydGlvbnMoKyksIDkgZGVsZXRp
b25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Z0L2Rpc3BsYXkuYyBi
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d2dC9kaXNwbGF5LmMKaW5kZXggMWEwYTRhZTQ4MjZlLi5l
NjIzMTNiNWY4YTYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d2dC9kaXNwbGF5
LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Z0L2Rpc3BsYXkuYwpAQCAtNDEyLDYgKzQx
MiwxMCBAQCBzdGF0aWMgdm9pZCBlbXVsYXRlX3ZibGFua19vbl9waXBlKHN0cnVjdCBpbnRlbF92
Z3B1ICp2Z3B1LCBpbnQgcGlwZSkKIAogCWlmIChwaXBlX2lzX2VuYWJsZWQodmdwdSwgcGlwZSkp
IHsKIAkJdmdwdV92cmVnX3QodmdwdSwgUElQRV9GUk1DT1VOVF9HNFgocGlwZSkpKys7CisJCWlm
ICh2Z3B1LT52ZGV2LnZibGFua190cmlnZ2VyICYmCisJCSAgICAhKHZncHUtPnZkZXYuZGlzcGxh
eV9ldmVudF9tYXNrICYgRElTUExBWV9WQkxBTktfRVZFTlQpKQorCQkJZXZlbnRmZF9zaWduYWwo
dmdwdS0+dmRldi52YmxhbmtfdHJpZ2dlciwgMSk7CisKIAkJaW50ZWxfdmdwdV90cmlnZ2VyX3Zp
cnR1YWxfZXZlbnQodmdwdSwgdmJsYW5rX2V2ZW50W3BpcGVdKTsKIAl9CiB9CmRpZmYgLS1naXQg
YS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQvZ3Z0LmggYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9n
dnQvZ3Z0LmgKaW5kZXggY2QyOWVhMjhkN2VkLi5iM2I0NzZlZTVhY2YgMTAwNjQ0Ci0tLSBhL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2d2dC9ndnQuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9n
dnQvZ3Z0LmgKQEAgLTE2NSw2ICsxNjUsOCBAQCBzdHJ1Y3QgaW50ZWxfdmdwdV9zdWJtaXNzaW9u
IHsKIAlib29sIGFjdGl2ZTsKIH07CiAKKyNkZWZpbmUgRElTUExBWV9WQkxBTktfRVZFTlQJKDEg
PDwgMCkKKwogc3RydWN0IGludGVsX3ZncHUgewogCXN0cnVjdCBpbnRlbF9ndnQgKmd2dDsKIAlz
dHJ1Y3QgbXV0ZXggdmdwdV9sb2NrOwpAQCAtMjA1LDYgKzIwNyw4IEBAIHN0cnVjdCBpbnRlbF92
Z3B1IHsKIAkJaW50IG51bV9pcnFzOwogCQlzdHJ1Y3QgZXZlbnRmZF9jdHggKmludHhfdHJpZ2dl
cjsKIAkJc3RydWN0IGV2ZW50ZmRfY3R4ICptc2lfdHJpZ2dlcjsKKwkJc3RydWN0IGV2ZW50ZmRf
Y3R4ICp2YmxhbmtfdHJpZ2dlcjsKKwkJdTMyIGRpc3BsYXlfZXZlbnRfbWFzazsKIAogCQkvKgog
CQkgKiBUd28gY2FjaGVzIGFyZSB1c2VkIHRvIGF2b2lkIG1hcHBpbmcgZHVwbGljYXRlZCBwYWdl
cyAoZWcuCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQva3ZtZ3QuYyBiL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2d2dC9rdm1ndC5jCmluZGV4IGYyMjJjOWNkN2E1Ni4uN2E4NDIy
MmQ3ZDJkIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQva3ZtZ3QuYworKysg
Yi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQva3ZtZ3QuYwpAQCAtMTIyMiw2ICsxMjIyLDggQEAg
c3RhdGljIGludCBpbnRlbF92Z3B1X2dldF9pcnFfY291bnQoc3RydWN0IGludGVsX3ZncHUgKnZn
cHUsIGludCB0eXBlKQogewogCWlmICh0eXBlID09IFZGSU9fUENJX0lOVFhfSVJRX0lOREVYIHx8
IHR5cGUgPT0gVkZJT19QQ0lfTVNJX0lSUV9JTkRFWCkKIAkJcmV0dXJuIDE7CisJZWxzZSBpZiAo
dHlwZSA8IFZGSU9fUENJX05VTV9JUlFTICsgdmdwdS0+dmRldi5udW1faXJxcykKKwkJcmV0dXJu
IHZncHUtPnZkZXYuaXJxW3R5cGUgLSBWRklPX1BDSV9OVU1fSVJRU10uY291bnQ7CiAKIAlyZXR1
cm4gMDsKIH0KQEAgLTEyNjksNyArMTI3MSw2MCBAQCBzdGF0aWMgaW50IGludGVsX3ZncHVfc2V0
X21zaV90cmlnZ2VyKHN0cnVjdCBpbnRlbF92Z3B1ICp2Z3B1LAogCXJldHVybiAwOwogfQogCi1z
dGF0aWMgaW50IGludGVsX3ZncHVfc2V0X2lycXMoc3RydWN0IGludGVsX3ZncHUgKnZncHUsIHUz
MiBmbGFncywKK3N0YXRpYyBpbnQgaW50ZWxfdmd1X3NldF9kaXNwbGF5X2lycV9tYXNrKHN0cnVj
dCBpbnRlbF92Z3B1ICp2Z3B1LAorCQl1bnNpZ25lZCBpbnQgaW5kZXgsIHVuc2lnbmVkIGludCBz
dGFydCwgdW5zaWduZWQgaW50IGNvdW50LAorCQl1MzIgZmxhZ3MsIHZvaWQgKmRhdGEpCit7CisJ
aWYgKHN0YXJ0ICE9IDAgfHwgY291bnQgIT0gMSkKKwkJcmV0dXJuIC1FSU5WQUw7CisKKwlpZiAo
ZmxhZ3MgJiBWRklPX0lSUV9TRVRfREFUQV9OT05FKQorCQl2Z3B1LT52ZGV2LmRpc3BsYXlfZXZl
bnRfbWFzayB8PSBESVNQTEFZX1ZCTEFOS19FVkVOVDsKKworCXJldHVybiAwOworfQorCitzdGF0
aWMgaW50IGludGVsX3ZndV9zZXRfZGlzcGxheV9pcnFfdW5tYXNrKHN0cnVjdCBpbnRlbF92Z3B1
ICp2Z3B1LAorCQl1bnNpZ25lZCBpbnQgaW5kZXgsIHVuc2lnbmVkIGludCBzdGFydCwgdW5zaWdu
ZWQgaW50IGNvdW50LAorCQl1MzIgZmxhZ3MsIHZvaWQgKmRhdGEpCit7CisJaWYgKHN0YXJ0ICE9
IDAgfHwgY291bnQgIT0gMSkKKwkJcmV0dXJuIC1FSU5WQUw7CisKKwlpZiAoZmxhZ3MgJiBWRklP
X0lSUV9TRVRfREFUQV9OT05FKQorCQl2Z3B1LT52ZGV2LmRpc3BsYXlfZXZlbnRfbWFzayAmPSB+
RElTUExBWV9WQkxBTktfRVZFTlQ7CisKKwlyZXR1cm4gMDsKK30KKworc3RhdGljIGludCBpbnRl
bF92Z3B1X3NldF9kaXNwbGF5X2V2ZW50X3RyaWdnZXIoc3RydWN0IGludGVsX3ZncHUgKnZncHUs
CisJCXVuc2lnbmVkIGludCBpbmRleCwgdW5zaWduZWQgaW50IHN0YXJ0LCB1bnNpZ25lZCBpbnQg
Y291bnQsCisJCXUzMiBmbGFncywgdm9pZCAqZGF0YSkKK3sKKwlzdHJ1Y3QgZXZlbnRmZF9jdHgg
KnRyaWdnZXI7CisKKwlpZiAoZmxhZ3MgJiBWRklPX0lSUV9TRVRfREFUQV9FVkVOVEZEKSB7CisJ
CWludCBmZCA9ICooaW50ICopZGF0YTsKKworCQl0cmlnZ2VyID0gZXZlbnRmZF9jdHhfZmRnZXQo
ZmQpOworCQlpZiAoSVNfRVJSKHRyaWdnZXIpKSB7CisJCQlndnRfdmdwdV9lcnIoImV2ZW50ZmRf
Y3R4X2ZkZ2V0IGZhaWxlZFxuIik7CisJCQlyZXR1cm4gUFRSX0VSUih0cmlnZ2VyKTsKKwkJfQor
CQl2Z3B1LT52ZGV2LnZibGFua190cmlnZ2VyID0gdHJpZ2dlcjsKKwkJdmdwdS0+dmRldi5kaXNw
bGF5X2V2ZW50X21hc2sgPSAwOworCX0gZWxzZSBpZiAoKGZsYWdzICYgVkZJT19JUlFfU0VUX0RB
VEFfTk9ORSkgJiYgIWNvdW50KSB7CisJCXRyaWdnZXIgPSB2Z3B1LT52ZGV2LnZibGFua190cmln
Z2VyOworCQlpZiAodHJpZ2dlcikgeworCQkJZXZlbnRmZF9jdHhfcHV0KHRyaWdnZXIpOworCQkJ
dmdwdS0+dmRldi52YmxhbmtfdHJpZ2dlciA9IE5VTEw7CisJCX0KKwl9CisKKwlyZXR1cm4gMDsK
K30KKworaW50IGludGVsX3ZncHVfc2V0X2lycXMoc3RydWN0IGludGVsX3ZncHUgKnZncHUsIHUz
MiBmbGFncywKIAkJdW5zaWduZWQgaW50IGluZGV4LCB1bnNpZ25lZCBpbnQgc3RhcnQsIHVuc2ln
bmVkIGludCBjb3VudCwKIAkJdm9pZCAqZGF0YSkKIHsKQEAgLTEzMDIsNiArMTM1NywzNSBAQCBz
dGF0aWMgaW50IGludGVsX3ZncHVfc2V0X2lycXMoc3RydWN0IGludGVsX3ZncHUgKnZncHUsIHUz
MiBmbGFncywKIAkJCWJyZWFrOwogCQl9CiAJCWJyZWFrOworCWRlZmF1bHQ6CisJeworCQlpbnQg
aTsKKworCQlpZiAoaW5kZXggPj0gVkZJT19QQ0lfTlVNX0lSUVMgKworCQkJCQl2Z3B1LT52ZGV2
Lm51bV9pcnFzKQorCQkJcmV0dXJuIC1FSU5WQUw7CisJCWluZGV4ID0KKwkJCWFycmF5X2luZGV4
X25vc3BlYyhpbmRleCwKKwkJCQkJCVZGSU9fUENJX05VTV9JUlFTICsKKwkJCQkJCXZncHUtPnZk
ZXYubnVtX2lycXMpOworCisJCWkgPSBpbmRleCAtIFZGSU9fUENJX05VTV9JUlFTOworCQlpZiAo
dmdwdS0+dmRldi5pcnFbaV0udHlwZSA9PSBWRklPX0lSUV9UWVBFX0dGWCAmJgorCQkgICAgdmdw
dS0+dmRldi5pcnFbaV0uc3VidHlwZSA9PQorCQkgICAgVkZJT19JUlFfU1VCVFlQRV9HRlhfRElT
UExBWV9JUlEpIHsKKwkJCXN3aXRjaCAoZmxhZ3MgJiBWRklPX0lSUV9TRVRfQUNUSU9OX1RZUEVf
TUFTSykgeworCQkJY2FzZSBWRklPX0lSUV9TRVRfQUNUSU9OX01BU0s6CisJCQkJZnVuYyA9IGlu
dGVsX3ZndV9zZXRfZGlzcGxheV9pcnFfbWFzazsKKwkJCQlicmVhazsKKwkJCWNhc2UgVkZJT19J
UlFfU0VUX0FDVElPTl9VTk1BU0s6CisJCQkJZnVuYyA9IGludGVsX3ZndV9zZXRfZGlzcGxheV9p
cnFfdW5tYXNrOworCQkJCWJyZWFrOworCQkJY2FzZSBWRklPX0lSUV9TRVRfQUNUSU9OX1RSSUdH
RVI6CisJCQkJZnVuYyA9IGludGVsX3ZncHVfc2V0X2Rpc3BsYXlfZXZlbnRfdHJpZ2dlcjsKKwkJ
CQlicmVhazsKKwkJCX0KKwkJfQorCX0KIAl9CiAKIAlpZiAoIWZ1bmMpCkBAIC0xMzMzLDcgKzE0
MTcsNyBAQCBzdGF0aWMgbG9uZyBpbnRlbF92Z3B1X2lvY3RsKHN0cnVjdCBtZGV2X2RldmljZSAq
bWRldiwgdW5zaWduZWQgaW50IGNtZCwKIAkJaW5mby5mbGFncyB8PSBWRklPX0RFVklDRV9GTEFH
U19SRVNFVDsKIAkJaW5mby5udW1fcmVnaW9ucyA9IFZGSU9fUENJX05VTV9SRUdJT05TICsKIAkJ
CQl2Z3B1LT52ZGV2Lm51bV9yZWdpb25zOwotCQlpbmZvLm51bV9pcnFzID0gVkZJT19QQ0lfTlVN
X0lSUVM7CisJCWluZm8ubnVtX2lycXMgPSBWRklPX1BDSV9OVU1fSVJRUyArIHZncHUtPnZkZXYu
bnVtX2lycXM7CiAKIAkJcmV0dXJuIGNvcHlfdG9fdXNlcigodm9pZCBfX3VzZXIgKilhcmcsICZp
bmZvLCBtaW5zeikgPwogCQkJLUVGQVVMVCA6IDA7CkBAIC0xNDkzLDMyICsxNTc3LDc5IEBAIHN0
YXRpYyBsb25nIGludGVsX3ZncHVfaW9jdGwoc3RydWN0IG1kZXZfZGV2aWNlICptZGV2LCB1bnNp
Z25lZCBpbnQgY21kLAogCQkJLUVGQVVMVCA6IDA7CiAJfSBlbHNlIGlmIChjbWQgPT0gVkZJT19E
RVZJQ0VfR0VUX0lSUV9JTkZPKSB7CiAJCXN0cnVjdCB2ZmlvX2lycV9pbmZvIGluZm87CisJCXN0
cnVjdCB2ZmlvX2luZm9fY2FwIGNhcHMgPSB7IC5idWYgPSBOVUxMLCAuc2l6ZSA9IDAgfTsKKwkJ
dW5zaWduZWQgaW50IGk7CisJCWludCByZXQ7CiAKIAkJbWluc3ogPSBvZmZzZXRvZmVuZChzdHJ1
Y3QgdmZpb19pcnFfaW5mbywgY291bnQpOwogCiAJCWlmIChjb3B5X2Zyb21fdXNlcigmaW5mbywg
KHZvaWQgX191c2VyICopYXJnLCBtaW5zeikpCiAJCQlyZXR1cm4gLUVGQVVMVDsKIAotCQlpZiAo
aW5mby5hcmdzeiA8IG1pbnN6IHx8IGluZm8uaW5kZXggPj0gVkZJT19QQ0lfTlVNX0lSUVMpCisJ
CWlmIChpbmZvLmFyZ3N6IDwgbWluc3opCiAJCQlyZXR1cm4gLUVJTlZBTDsKIAogCQlzd2l0Y2gg
KGluZm8uaW5kZXgpIHsKIAkJY2FzZSBWRklPX1BDSV9JTlRYX0lSUV9JTkRFWDoKIAkJY2FzZSBW
RklPX1BDSV9NU0lfSVJRX0lOREVYOgorCQkJaW5mby5mbGFncyA9IFZGSU9fSVJRX0lORk9fRVZF
TlRGRDsKIAkJCWJyZWFrOwotCQlkZWZhdWx0OgorCQljYXNlIFZGSU9fUENJX01TSVhfSVJRX0lO
REVYOgorCQljYXNlIFZGSU9fUENJX0VSUl9JUlFfSU5ERVg6CisJCWNhc2UgVkZJT19QQ0lfUkVR
X0lSUV9JTkRFWDoKIAkJCXJldHVybiAtRUlOVkFMOwotCQl9CisJCWRlZmF1bHQ6CisJCXsKKwkJ
CXN0cnVjdCB2ZmlvX2lycV9pbmZvX2NhcF90eXBlIGNhcF90eXBlID0geworCQkJCS5oZWFkZXIu
aWQgPSBWRklPX0lSUV9JTkZPX0NBUF9UWVBFLAorCQkJCS5oZWFkZXIudmVyc2lvbiA9IDEgfTsK
IAotCQlpbmZvLmZsYWdzID0gVkZJT19JUlFfSU5GT19FVkVOVEZEOworCQkJaWYgKGluZm8uaW5k
ZXggPj0gVkZJT19QQ0lfTlVNX0lSUVMgKworCQkJCQl2Z3B1LT52ZGV2Lm51bV9pcnFzKQorCQkJ
CXJldHVybiAtRUlOVkFMOworCQkJaW5mby5pbmRleCA9CisJCQkJYXJyYXlfaW5kZXhfbm9zcGVj
KGluZm8uaW5kZXgsCisJCQkJCQlWRklPX1BDSV9OVU1fSVJRUyArCisJCQkJCQl2Z3B1LT52ZGV2
Lm51bV9pcnFzKTsKKworCQkJaSA9IGluZm8uaW5kZXggLSBWRklPX1BDSV9OVU1fSVJRUzsKKwor
CQkJaW5mby5mbGFncyA9IHZncHUtPnZkZXYuaXJxW2ldLmZsYWdzOworCQkJY2FwX3R5cGUudHlw
ZSA9IHZncHUtPnZkZXYuaXJxW2ldLnR5cGU7CisJCQljYXBfdHlwZS5zdWJ0eXBlID0gdmdwdS0+
dmRldi5pcnFbaV0uc3VidHlwZTsKKworCQkJcmV0ID0gdmZpb19pbmZvX2FkZF9jYXBhYmlsaXR5
KCZjYXBzLAorCQkJCQkJJmNhcF90eXBlLmhlYWRlciwKKwkJCQkJCXNpemVvZihjYXBfdHlwZSkp
OworCQkJaWYgKHJldCkKKwkJCQlyZXR1cm4gcmV0OworCQl9CisJCX0KIAogCQlpbmZvLmNvdW50
ID0gaW50ZWxfdmdwdV9nZXRfaXJxX2NvdW50KHZncHUsIGluZm8uaW5kZXgpOwogCiAJCWlmIChp
bmZvLmluZGV4ID09IFZGSU9fUENJX0lOVFhfSVJRX0lOREVYKQogCQkJaW5mby5mbGFncyB8PSAo
VkZJT19JUlFfSU5GT19NQVNLQUJMRSB8CiAJCQkJICAgICAgIFZGSU9fSVJRX0lORk9fQVVUT01B
U0tFRCk7Ci0JCWVsc2UKLQkJCWluZm8uZmxhZ3MgfD0gVkZJT19JUlFfSU5GT19OT1JFU0laRTsK
KworCQlpZiAoY2Fwcy5zaXplKSB7CisJCQlpbmZvLmZsYWdzIHw9IFZGSU9fSVJRX0lORk9fRkxB
R19DQVBTOworCQkJaWYgKGluZm8uYXJnc3ogPCBzaXplb2YoaW5mbykgKyBjYXBzLnNpemUpIHsK
KwkJCQlpbmZvLmFyZ3N6ID0gc2l6ZW9mKGluZm8pICsgY2Fwcy5zaXplOworCQkJCWluZm8uY2Fw
X29mZnNldCA9IDA7CisJCQl9IGVsc2UgeworCQkJCXZmaW9faW5mb19jYXBfc2hpZnQoJmNhcHMs
IHNpemVvZihpbmZvKSk7CisJCQkJaWYgKGNvcHlfdG9fdXNlcigodm9pZCBfX3VzZXIgKilhcmcg
KworCQkJCQkJICBzaXplb2YoaW5mbyksIGNhcHMuYnVmLAorCQkJCQkJICBjYXBzLnNpemUpKSB7
CisJCQkJCWtmcmVlKGNhcHMuYnVmKTsKKwkJCQkJcmV0dXJuIC1FRkFVTFQ7CisJCQkJfQorCQkJ
CWluZm8uY2FwX29mZnNldCA9IHNpemVvZihpbmZvKTsKKwkJCX0KKworCQkJa2ZyZWUoY2Fwcy5i
dWYpOworCQl9CiAKIAkJcmV0dXJuIGNvcHlfdG9fdXNlcigodm9pZCBfX3VzZXIgKilhcmcsICZp
bmZvLCBtaW5zeikgPwogCQkJLUVGQVVMVCA6IDA7CkBAIC0xNTM3LDcgKzE2NjgsOCBAQCBzdGF0
aWMgbG9uZyBpbnRlbF92Z3B1X2lvY3RsKHN0cnVjdCBtZGV2X2RldmljZSAqbWRldiwgdW5zaWdu
ZWQgaW50IGNtZCwKIAkJCWludCBtYXggPSBpbnRlbF92Z3B1X2dldF9pcnFfY291bnQodmdwdSwg
aGRyLmluZGV4KTsKIAogCQkJcmV0ID0gdmZpb19zZXRfaXJxc192YWxpZGF0ZV9hbmRfcHJlcGFy
ZSgmaGRyLCBtYXgsCi0JCQkJCQlWRklPX1BDSV9OVU1fSVJRUywgJmRhdGFfc2l6ZSk7CisJCQkJ
CVZGSU9fUENJX05VTV9JUlFTICsgdmdwdS0+dmRldi5udW1faXJxcywKKwkJCQkJCQkJICZkYXRh
X3NpemUpOwogCQkJaWYgKHJldCkgewogCQkJCWd2dF92Z3B1X2VycigiaW50ZWw6dmZpb19zZXRf
aXJxc192YWxpZGF0ZV9hbmRfcHJlcGFyZSBmYWlsZWRcbiIpOwogCQkJCXJldHVybiAtRUlOVkFM
OwotLSAKMi4xNy4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fXwppbnRlbC1ndnQtZGV2IG1haWxpbmcgbGlzdAppbnRlbC1ndnQtZGV2QGxpc3RzLmZyZWVk
ZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZv
L2ludGVsLWd2dC1kZXY=
