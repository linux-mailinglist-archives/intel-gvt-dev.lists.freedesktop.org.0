Return-Path: <intel-gvt-dev-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gvt-dev@lfdr.de
Delivered-To: lists+intel-gvt-dev@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id DC668786DC
	for <lists+intel-gvt-dev@lfdr.de>; Mon, 29 Jul 2019 09:59:17 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 9ABA289D4B;
	Mon, 29 Jul 2019 07:59:15 +0000 (UTC)
X-Original-To: intel-gvt-dev@lists.freedesktop.org
Delivered-To: intel-gvt-dev@lists.freedesktop.org
Received: from mga18.intel.com (mga18.intel.com [134.134.136.126])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 4374089D43;
 Mon, 29 Jul 2019 07:59:13 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga001.jf.intel.com ([10.7.209.18])
 by orsmga106.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 29 Jul 2019 00:58:00 -0700
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.64,322,1559545200"; d="scan'208";a="255150123"
Received: from vca-bj102.bj.intel.com ([10.240.193.76])
 by orsmga001.jf.intel.com with ESMTP; 29 Jul 2019 00:57:58 -0700
From: Xiaolin Zhang <xiaolin.zhang@intel.com>
To: intel-gvt-dev@lists.freedesktop.org,
	intel-gfx@lists.freedesktop.org
Subject: [PATCH v9 7/9] drm/i915/gvt: GVTg handle shared_page setup
Date: Tue, 30 Jul 2019 00:32:40 +0800
Message-Id: <1564417962-74325-8-git-send-email-xiaolin.zhang@intel.com>
X-Mailer: git-send-email 1.8.3.1
In-Reply-To: <1564417962-74325-1-git-send-email-xiaolin.zhang@intel.com>
References: <1564417962-74325-1-git-send-email-xiaolin.zhang@intel.com>
X-BeenThere: intel-gvt-dev@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: "Intel GVT \(Graphics Virtualization\) development list"
 <intel-gvt-dev.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gvt-dev>, 
 <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gvt-dev>
List-Post: <mailto:intel-gvt-dev@lists.freedesktop.org>
List-Help: <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gvt-dev>, 
 <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=subscribe>
Cc: Xiaolin Zhang <xiaolin.zhang@intel.com>, zhenyu.z.wang@intel.com,
 joonas.lahtinen@linux.intel.com, hang.yuan@intel.com, min.he@intel.com,
 zhiyuan.lv@intel.com, chris@chris-wilson.co.uk, zhi.a.wang@intel.com
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gvt-dev-bounces@lists.freedesktop.org
Sender: "intel-gvt-dev" <intel-gvt-dev-bounces@lists.freedesktop.org>

R1ZUZyBpbXBsZW1lbnRlZCBzaGFyZWRfcGFnZSBzZXR1cCBvcGVyYXRpb24gYW5kIHJlYWRfc2hh
cmVkX3BhZ2UKZnVuY3Rpb25hbGl0eSBiYXNlZCBvbiBoeXBlcnZpc29yX3JlYWRfZ3BhKCkuCgp0
aGUgc2hhcmVkX3BhZ2VfZ3BhIHdhcyBwYXNzZWQgZnJvbSBndWVzdCBkcml2ZXIgdGhyb3VnaCBQ
VklORk8Kc2hhcmVkX3BhZ2VfZ3BhIHJlZ2lzdGVyLgoKdjA6IFJGQy4KdjE6IHJlYmFzZS4KdjI6
IHJlYmFzZS4KdjM6IGFkZGVkIHNoYXJlZF9wYWdlX2dwYSBjaGVjayBhbmQgaWYgcmVhZF9ncGEg
ZmFpbHVyZSwgcmV0dXJuIHplcm8KbWVtb3J5IGFuZCBoYW5kbGUgVkdUX0cyVl9TSEFSRURfUEFH
RV9TRVRVUCBnMnYgbm90aWZpY2F0aW9uCnY0OiByZWJhc2UuCnY1OiByZWJhc2UuCnY2OiByZWJh
c2UsIGFkZGVkIFBWIHZlcnNpb24gc3VwcG9ydC4Kdjc6IHJlYmFzZS4KClNpZ25lZC1vZmYtYnk6
IFhpYW9saW4gWmhhbmcgPHhpYW9saW4uemhhbmdAaW50ZWwuY29tPgotLS0KIGRyaXZlcnMvZ3B1
L2RybS9pOTE1L2d2dC9ndnQuaCAgICAgIHwgIDggKysrKysrLQogZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ3Z0L2hhbmRsZXJzLmMgfCAyMCArKysrKysrKysrKysrKysrKwogZHJpdmVycy9ncHUvZHJt
L2k5MTUvZ3Z0L3ZncHUuYyAgICAgfCA0MyArKysrKysrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKysrCiAzIGZpbGVzIGNoYW5nZWQsIDcwIGluc2VydGlvbnMoKyksIDEgZGVsZXRpb24oLSkK
CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQvZ3Z0LmggYi9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9ndnQvZ3Z0LmgKaW5kZXggN2ExZmU0NC4uZjdmNGIwMyAxMDA2NDQKLS0tIGEv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Z0L2d2dC5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2d2dC9ndnQuaApAQCAtNDksNiArNDksNyBAQAogI2luY2x1ZGUgImZiX2RlY29kZXIuaCIKICNp
bmNsdWRlICJkbWFidWYuaCIKICNpbmNsdWRlICJwYWdlX3RyYWNrLmgiCisjaW5jbHVkZSAiaTkx
NV92Z3B1LmgiCiAKICNkZWZpbmUgR1ZUX01BWF9WR1BVIDgKIApAQCAtMjI5LDYgKzIzMCw4IEBA
IHN0cnVjdCBpbnRlbF92Z3B1IHsKIAlzdHJ1Y3QgY29tcGxldGlvbiB2YmxhbmtfZG9uZTsKIAog
CXUzMiBzY2FuX25vbnByaXZiYjsKKwl1NjQgc2hhcmVkX3BhZ2VfZ3BhOworCWJvb2wgc2hhcmVk
X3BhZ2VfZW5hYmxlZDsKIH07CiAKIC8qIHZhbGlkYXRpbmcgR00gaGVhbHRoeSBzdGF0dXMqLwpA
QCAtNjg2LDcgKzY4OSwxMCBAQCBzdGF0aWMgaW5saW5lIHZvaWQgaW50ZWxfZ3Z0X21taW9fc2V0
X2luX2N0eCgKIHZvaWQgaW50ZWxfZ3Z0X2RlYnVnZnNfcmVtb3ZlX3ZncHUoc3RydWN0IGludGVs
X3ZncHUgKnZncHUpOwogaW50IGludGVsX2d2dF9kZWJ1Z2ZzX2luaXQoc3RydWN0IGludGVsX2d2
dCAqZ3Z0KTsKIHZvaWQgaW50ZWxfZ3Z0X2RlYnVnZnNfY2xlYW4oc3RydWN0IGludGVsX2d2dCAq
Z3Z0KTsKLQoraW50IGludGVsX2d2dF9yZWFkX3NoYXJlZF9wYWdlKHN0cnVjdCBpbnRlbF92Z3B1
ICp2Z3B1LAorCQl1bnNpZ25lZCBpbnQgb2Zmc2V0LCB2b2lkICpidWYsIHVuc2lnbmVkIGxvbmcg
bGVuKTsKK2ludCBpbnRlbF9ndnRfd3JpdGVfc2hhcmVkX3BhZ2Uoc3RydWN0IGludGVsX3ZncHUg
KnZncHUsCisJCXVuc2lnbmVkIGludCBvZmZzZXQsIHZvaWQgKmJ1ZiwgdW5zaWduZWQgbG9uZyBs
ZW4pOwogCiAjaW5jbHVkZSAidHJhY2UuaCIKICNpbmNsdWRlICJtcHQuaCIKZGlmZiAtLWdpdCBh
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d2dC9oYW5kbGVycy5jIGIvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ3Z0L2hhbmRsZXJzLmMKaW5kZXggZGVkOTdiMy4uNDExNWZkMCAxMDA2NDQKLS0tIGEvZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ3Z0L2hhbmRsZXJzLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ3Z0L2hhbmRsZXJzLmMKQEAgLTExOTUsNiArMTE5NSw4IEBAIHN0YXRpYyBpbnQgcHZpbmZv
X21taW9fcmVhZChzdHJ1Y3QgaW50ZWxfdmdwdSAqdmdwdSwgdW5zaWduZWQgaW50IG9mZnNldCwK
IAljYXNlIDB4NzgwMTA6CS8qIHZndF9jYXBzICovCiAJY2FzZSAweDc4ODFjOgogCWNhc2UgX3Zn
dGlmX3JlZyhwdl9jYXBzKToKKwljYXNlIF92Z3RpZl9yZWcoc2hhcmVkX3BhZ2VfZ3BhKToKKwlj
YXNlIF92Z3RpZl9yZWcoc2hhcmVkX3BhZ2VfZ3BhKSArIDQ6CiAJCWJyZWFrOwogCWRlZmF1bHQ6
CiAJCWludmFsaWRfcmVhZCA9IHRydWU7CkBAIC0xMjEyLDYgKzEyMTQsOSBAQCBzdGF0aWMgaW50
IGhhbmRsZV9nMnZfbm90aWZpY2F0aW9uKHN0cnVjdCBpbnRlbF92Z3B1ICp2Z3B1LCBpbnQgbm90
aWZpY2F0aW9uKQogCWVudW0gaW50ZWxfZ3Z0X2d0dF90eXBlIHJvb3RfZW50cnlfdHlwZSA9IEdU
VF9UWVBFX1BQR1RUX1JPT1RfTDRfRU5UUlk7CiAJc3RydWN0IGludGVsX3ZncHVfbW0gKm1tOwog
CXU2NCAqcGRwczsKKwl1bnNpZ25lZCBsb25nIGdwYSwgZ2ZuOworCXUxNiB2ZXJfbWFqb3IgPSBQ
Vl9NQUpPUjsKKwl1MTYgdmVyX21pbm9yID0gUFZfTUlOT1I7CiAKIAlwZHBzID0gKHU2NCAqKSZ2
Z3B1X3ZyZWc2NF90KHZncHUsIHZndGlmX3JlZyhwZHBbMF0pKTsKIApAQCAtMTIyNSw2ICsxMjMw
LDE5IEBAIHN0YXRpYyBpbnQgaGFuZGxlX2cydl9ub3RpZmljYXRpb24oc3RydWN0IGludGVsX3Zn
cHUgKnZncHUsIGludCBub3RpZmljYXRpb24pCiAJY2FzZSBWR1RfRzJWX1BQR1RUX0wzX1BBR0Vf
VEFCTEVfREVTVFJPWToKIAljYXNlIFZHVF9HMlZfUFBHVFRfTDRfUEFHRV9UQUJMRV9ERVNUUk9Z
OgogCQlyZXR1cm4gaW50ZWxfdmdwdV9wdXRfcHBndHRfbW0odmdwdSwgcGRwcyk7CisJY2FzZSBW
R1RfRzJWX1NIQVJFRF9QQUdFX1NFVFVQOgorCQlncGEgPSB2Z3B1X3ZyZWc2NF90KHZncHUsIHZn
dGlmX3JlZyhzaGFyZWRfcGFnZV9ncGEpKTsKKwkJZ2ZuID0gZ3BhID4+IFBBR0VfU0hJRlQ7CisJ
CWlmICghaW50ZWxfZ3Z0X2h5cGVydmlzb3JfaXNfdmFsaWRfZ2ZuKHZncHUsIGdmbikpIHsKKwkJ
CXZncHVfdnJlZ190KHZncHUsIHZndGlmX3JlZyhwdl9jYXBzKSkgPSAwOworCQkJcmV0dXJuIDA7
CisJCX0KKwkJdmdwdS0+c2hhcmVkX3BhZ2VfZ3BhID0gZ3BhOworCQl2Z3B1LT5zaGFyZWRfcGFn
ZV9lbmFibGVkID0gdHJ1ZTsKKworCQlpbnRlbF9ndnRfd3JpdGVfc2hhcmVkX3BhZ2UodmdwdSwg
MCwgJnZlcl9tYWpvciwgMik7CisJCWludGVsX2d2dF93cml0ZV9zaGFyZWRfcGFnZSh2Z3B1LCAy
LCAmdmVyX21pbm9yLCAyKTsKKwkJYnJlYWs7CiAJY2FzZSBWR1RfRzJWX0VYRUNMSVNUX0NPTlRF
WFRfQ1JFQVRFOgogCWNhc2UgVkdUX0cyVl9FWEVDTElTVF9DT05URVhUX0RFU1RST1k6CiAJY2Fz
ZSAxOgkvKiBSZW1vdmUgdGhpcyBpbiBndWVzdCBkcml2ZXIuICovCkBAIC0xMjgxLDYgKzEyOTks
OCBAQCBzdGF0aWMgaW50IHB2aW5mb19tbWlvX3dyaXRlKHN0cnVjdCBpbnRlbF92Z3B1ICp2Z3B1
LCB1bnNpZ25lZCBpbnQgb2Zmc2V0LAogCWNhc2UgX3ZndGlmX3JlZyhwZHBbM10uaGkpOgogCWNh
c2UgX3ZndGlmX3JlZyhleGVjbGlzdF9jb250ZXh0X2Rlc2NyaXB0b3JfbG8pOgogCWNhc2UgX3Zn
dGlmX3JlZyhleGVjbGlzdF9jb250ZXh0X2Rlc2NyaXB0b3JfaGkpOgorCWNhc2UgX3ZndGlmX3Jl
ZyhzaGFyZWRfcGFnZV9ncGEpOgorCWNhc2UgX3ZndGlmX3JlZyhzaGFyZWRfcGFnZV9ncGEpICsg
NDoKIAkJYnJlYWs7CiAJY2FzZSBfdmd0aWZfcmVnKHJzdjVbMF0pLi4uX3ZndGlmX3JlZyhyc3Y1
WzNdKToKIAkJaW52YWxpZF93cml0ZSA9IHRydWU7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9ndnQvdmdwdS5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Z0L3ZncHUuYwppbmRl
eCAzZWNjNDVhLi4xNTFmMjcxIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQv
dmdwdS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d2dC92Z3B1LmMKQEAgLTYzLDYgKzYz
LDggQEAgdm9pZCBwb3B1bGF0ZV9wdmluZm9fcGFnZShzdHJ1Y3QgaW50ZWxfdmdwdSAqdmdwdSkK
IAl2Z3B1X3ZyZWdfdCh2Z3B1LCB2Z3RpZl9yZWcoY3Vyc29yX3hfaG90KSkgPSBVSU5UX01BWDsK
IAl2Z3B1X3ZyZWdfdCh2Z3B1LCB2Z3RpZl9yZWcoY3Vyc29yX3lfaG90KSkgPSBVSU5UX01BWDsK
IAorCXZncHVfdnJlZzY0X3QodmdwdSwgdmd0aWZfcmVnKHNoYXJlZF9wYWdlX2dwYSkpID0gMDsK
KwogCWd2dF9kYmdfY29yZSgiUG9wdWxhdGUgUFZJTkZPIFBBR0UgZm9yIHZHUFUgJWRcbiIsIHZn
cHUtPmlkKTsKIAlndnRfZGJnX2NvcmUoImFwZXJ0dXJlIGJhc2UgW0dNQURSXSAweCVsbHggc2l6
ZSAweCVsbHhcbiIsCiAJCXZncHVfYXBlcnR1cmVfZ21hZHJfYmFzZSh2Z3B1KSwgdmdwdV9hcGVy
dHVyZV9zeih2Z3B1KSk7CkBAIC01OTMsMyArNTk1LDQ0IEBAIHZvaWQgaW50ZWxfZ3Z0X3Jlc2V0
X3ZncHUoc3RydWN0IGludGVsX3ZncHUgKnZncHUpCiAJaW50ZWxfZ3Z0X3Jlc2V0X3ZncHVfbG9j
a2VkKHZncHUsIHRydWUsIDApOwogCW11dGV4X3VubG9jaygmdmdwdS0+dmdwdV9sb2NrKTsKIH0K
KworLyoqCisgKiBpbnRlbF9ndnRfcmVhZF9zaGFyZWRfcGFnZSAtIHJlYWQgY29udGVudCBmcm9t
IHNoYXJlZCBwYWdlCisgKi8KK2ludCBpbnRlbF9ndnRfcmVhZF9zaGFyZWRfcGFnZShzdHJ1Y3Qg
aW50ZWxfdmdwdSAqdmdwdSwKKwkJdW5zaWduZWQgaW50IG9mZnNldCwgdm9pZCAqYnVmLCB1bnNp
Z25lZCBsb25nIGxlbikKK3sKKwlpbnQgcmV0ID0gLUVJTlZBTDsKKwl1bnNpZ25lZCBsb25nIGdw
YTsKKworCWlmIChvZmZzZXQgPj0gUEFHRV9TSVpFKQorCQlnb3RvIGVycjsKKworCWdwYSA9IHZn
cHUtPnNoYXJlZF9wYWdlX2dwYSArIG9mZnNldDsKKwlyZXQgPSBpbnRlbF9ndnRfaHlwZXJ2aXNv
cl9yZWFkX2dwYSh2Z3B1LCBncGEsIGJ1ZiwgbGVuKTsKKwlpZiAoIXJldCkKKwkJcmV0dXJuIHJl
dDsKK2VycjoKKwlndnRfdmdwdV9lcnIoInJlYWQgc2hhcmVkIHBhZ2UgKG9mZnNldCAleCkgZmFp
bGVkIiwgb2Zmc2V0KTsKKwltZW1zZXQoYnVmLCAwLCBsZW4pOworCXJldHVybiByZXQ7Cit9CisK
K2ludCBpbnRlbF9ndnRfd3JpdGVfc2hhcmVkX3BhZ2Uoc3RydWN0IGludGVsX3ZncHUgKnZncHUs
CisJCXVuc2lnbmVkIGludCBvZmZzZXQsIHZvaWQgKmJ1ZiwgdW5zaWduZWQgbG9uZyBsZW4pCit7
CisJaW50IHJldCA9IC1FSU5WQUw7CisJdW5zaWduZWQgbG9uZyBncGE7CisKKwlpZiAob2Zmc2V0
ID49IFBBR0VfU0laRSkKKwkJZ290byBlcnI7CisKKwlncGEgPSB2Z3B1LT5zaGFyZWRfcGFnZV9n
cGEgKyBvZmZzZXQ7CisJcmV0ID0gaW50ZWxfZ3Z0X2h5cGVydmlzb3Jfd3JpdGVfZ3BhKHZncHUs
IGdwYSwgYnVmLCBsZW4pOworCWlmICghcmV0KQorCQlyZXR1cm4gcmV0OworZXJyOgorCWd2dF92
Z3B1X2Vycigid3JpdGUgc2hhcmVkIHBhZ2UgKG9mZnNldCAleCkgZmFpbGVkIiwgb2Zmc2V0KTsK
KwltZW1zZXQoYnVmLCAwLCBsZW4pOworCXJldHVybiByZXQ7Cit9Ci0tIAoxLjguMy4xCgpfX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwppbnRlbC1ndnQtZGV2
IG1haWxpbmcgbGlzdAppbnRlbC1ndnQtZGV2QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczov
L2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWd2dC1kZXY=
