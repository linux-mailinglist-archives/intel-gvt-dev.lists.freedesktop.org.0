Return-Path: <intel-gvt-dev-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gvt-dev@lfdr.de
Delivered-To: lists+intel-gvt-dev@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id ED75FB4705
	for <lists+intel-gvt-dev@lfdr.de>; Tue, 17 Sep 2019 07:49:08 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id BA7DE6E12F;
	Tue, 17 Sep 2019 05:49:07 +0000 (UTC)
X-Original-To: intel-gvt-dev@lists.freedesktop.org
Delivered-To: intel-gvt-dev@lists.freedesktop.org
Received: from mga12.intel.com (mga12.intel.com [192.55.52.136])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 981E46E127;
 Tue, 17 Sep 2019 05:49:06 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from fmsmga005.fm.intel.com ([10.253.24.32])
 by fmsmga106.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 16 Sep 2019 22:49:06 -0700
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.64,515,1559545200"; d="scan'208";a="386441292"
Received: from xzhan34-mobl3.bj.intel.com ([10.238.154.70])
 by fmsmga005.fm.intel.com with ESMTP; 16 Sep 2019 22:49:04 -0700
From: Xiaolin Zhang <xiaolin.zhang@intel.com>
To: intel-gvt-dev@lists.freedesktop.org,
	intel-gfx@lists.freedesktop.org
Subject: [PATCH v10 7/9] drm/i915/gvt: GVTg handle shared_page setup
Date: Tue, 17 Sep 2019 13:48:18 +0800
Message-Id: <1568699301-2799-8-git-send-email-xiaolin.zhang@intel.com>
X-Mailer: git-send-email 2.7.4
In-Reply-To: <1568699301-2799-1-git-send-email-xiaolin.zhang@intel.com>
References: <1568699301-2799-1-git-send-email-xiaolin.zhang@intel.com>
X-BeenThere: intel-gvt-dev@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: "Intel GVT \(Graphics Virtualization\) development list"
 <intel-gvt-dev.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gvt-dev>, 
 <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gvt-dev>
List-Post: <mailto:intel-gvt-dev@lists.freedesktop.org>
List-Help: <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gvt-dev>, 
 <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=subscribe>
Cc: Xiaolin Zhang <xiaolin.zhang@intel.com>, zhenyu.z.wang@intel.com,
 joonas.lahtinen@linux.intel.com, hang.yuan@intel.com, zhiyuan.lv@intel.com,
 chris@chris-wilson.co.uk, zhi.a.wang@intel.com
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gvt-dev-bounces@lists.freedesktop.org
Sender: "intel-gvt-dev" <intel-gvt-dev-bounces@lists.freedesktop.org>

R1ZUZyBpbXBsZW1lbnRlZCBzaGFyZWRfcGFnZSBzZXR1cCBvcGVyYXRpb24gYW5kIHJlYWRfc2hh
cmVkX3BhZ2UKZnVuY3Rpb25hbGl0eSBiYXNlZCBvbiBoeXBlcnZpc29yX3JlYWRfZ3BhKCkuCgp0
aGUgc2hhcmVkX3BhZ2VfZ3BhIHdhcyBwYXNzZWQgZnJvbSBndWVzdCBkcml2ZXIgdGhyb3VnaCBQ
VklORk8Kc2hhcmVkX3BhZ2VfZ3BhIHJlZ2lzdGVyLgoKdjA6IFJGQy4KdjE6IHJlYmFzZS4KdjI6
IHJlYmFzZS4KdjM6IGFkZGVkIHNoYXJlZF9wYWdlX2dwYSBjaGVjayBhbmQgaWYgcmVhZF9ncGEg
ZmFpbHVyZSwgcmV0dXJuIHplcm8KbWVtb3J5IGFuZCBoYW5kbGUgVkdUX0cyVl9TSEFSRURfUEFH
RV9TRVRVUCBnMnYgbm90aWZpY2F0aW9uCnY0OiByZWJhc2UuCnY1OiByZWJhc2UuCnY2OiByZWJh
c2UsIGFkZGVkIFBWIHZlcnNpb24gc3VwcG9ydC4Kdjc6IHJlYmFzZS4KClNpZ25lZC1vZmYtYnk6
IFhpYW9saW4gWmhhbmcgPHhpYW9saW4uemhhbmdAaW50ZWwuY29tPgotLS0KIGRyaXZlcnMvZ3B1
L2RybS9pOTE1L2d2dC9ndnQuaCAgICAgIHwgIDggKysrKysrLQogZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ3Z0L2hhbmRsZXJzLmMgfCAyMCArKysrKysrKysrKysrKysrKwogZHJpdmVycy9ncHUvZHJt
L2k5MTUvZ3Z0L3ZncHUuYyAgICAgfCA0MyArKysrKysrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKysrCiAzIGZpbGVzIGNoYW5nZWQsIDcwIGluc2VydGlvbnMoKyksIDEgZGVsZXRpb24oLSkK
CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQvZ3Z0LmggYi9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9ndnQvZ3Z0LmgKaW5kZXggYjQ3YzZhYy4uNzEyMTNlMCAxMDA2NDQKLS0tIGEv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Z0L2d2dC5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2d2dC9ndnQuaApAQCAtNDksNiArNDksNyBAQAogI2luY2x1ZGUgImZiX2RlY29kZXIuaCIKICNp
bmNsdWRlICJkbWFidWYuaCIKICNpbmNsdWRlICJwYWdlX3RyYWNrLmgiCisjaW5jbHVkZSAiaTkx
NV92Z3B1LmgiCiAKICNkZWZpbmUgR1ZUX01BWF9WR1BVIDgKIApAQCAtMjI5LDYgKzIzMCw4IEBA
IHN0cnVjdCBpbnRlbF92Z3B1IHsKIAlzdHJ1Y3QgY29tcGxldGlvbiB2YmxhbmtfZG9uZTsKIAog
CXUzMiBzY2FuX25vbnByaXZiYjsKKwl1NjQgc2hhcmVkX3BhZ2VfZ3BhOworCWJvb2wgc2hhcmVk
X3BhZ2VfZW5hYmxlZDsKIH07CiAKIC8qIHZhbGlkYXRpbmcgR00gaGVhbHRoeSBzdGF0dXMqLwpA
QCAtNjkwLDcgKzY5MywxMCBAQCBzdGF0aWMgaW5saW5lIHZvaWQgaW50ZWxfZ3Z0X21taW9fc2V0
X2luX2N0eCgKIHZvaWQgaW50ZWxfZ3Z0X2RlYnVnZnNfcmVtb3ZlX3ZncHUoc3RydWN0IGludGVs
X3ZncHUgKnZncHUpOwogdm9pZCBpbnRlbF9ndnRfZGVidWdmc19pbml0KHN0cnVjdCBpbnRlbF9n
dnQgKmd2dCk7CiB2b2lkIGludGVsX2d2dF9kZWJ1Z2ZzX2NsZWFuKHN0cnVjdCBpbnRlbF9ndnQg
Kmd2dCk7Ci0KK2ludCBpbnRlbF9ndnRfcmVhZF9zaGFyZWRfcGFnZShzdHJ1Y3QgaW50ZWxfdmdw
dSAqdmdwdSwKKwkJdW5zaWduZWQgaW50IG9mZnNldCwgdm9pZCAqYnVmLCB1bnNpZ25lZCBsb25n
IGxlbik7CitpbnQgaW50ZWxfZ3Z0X3dyaXRlX3NoYXJlZF9wYWdlKHN0cnVjdCBpbnRlbF92Z3B1
ICp2Z3B1LAorCQl1bnNpZ25lZCBpbnQgb2Zmc2V0LCB2b2lkICpidWYsIHVuc2lnbmVkIGxvbmcg
bGVuKTsKIAogI2luY2x1ZGUgInRyYWNlLmgiCiAjaW5jbHVkZSAibXB0LmgiCmRpZmYgLS1naXQg
YS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQvaGFuZGxlcnMuYyBiL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2d2dC9oYW5kbGVycy5jCmluZGV4IGFjZWIxNmYuLmViMDkwMDMgMTAwNjQ0Ci0tLSBhL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2d2dC9oYW5kbGVycy5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2d2dC9oYW5kbGVycy5jCkBAIC0xMTk1LDYgKzExOTUsOCBAQCBzdGF0aWMgaW50IHB2aW5m
b19tbWlvX3JlYWQoc3RydWN0IGludGVsX3ZncHUgKnZncHUsIHVuc2lnbmVkIGludCBvZmZzZXQs
CiAJY2FzZSAweDc4MDEwOgkvKiB2Z3RfY2FwcyAqLwogCWNhc2UgMHg3ODgxYzoKIAljYXNlIF92
Z3RpZl9yZWcocHZfY2Fwcyk6CisJY2FzZSBfdmd0aWZfcmVnKHNoYXJlZF9wYWdlX2dwYSk6CisJ
Y2FzZSBfdmd0aWZfcmVnKHNoYXJlZF9wYWdlX2dwYSkgKyA0OgogCQlicmVhazsKIAlkZWZhdWx0
OgogCQlpbnZhbGlkX3JlYWQgPSB0cnVlOwpAQCAtMTIxMiw2ICsxMjE0LDkgQEAgc3RhdGljIGlu
dCBoYW5kbGVfZzJ2X25vdGlmaWNhdGlvbihzdHJ1Y3QgaW50ZWxfdmdwdSAqdmdwdSwgaW50IG5v
dGlmaWNhdGlvbikKIAllbnVtIGludGVsX2d2dF9ndHRfdHlwZSByb290X2VudHJ5X3R5cGUgPSBH
VFRfVFlQRV9QUEdUVF9ST09UX0w0X0VOVFJZOwogCXN0cnVjdCBpbnRlbF92Z3B1X21tICptbTsK
IAl1NjQgKnBkcHM7CisJdW5zaWduZWQgbG9uZyBncGEsIGdmbjsKKwl1MTYgdmVyX21ham9yID0g
UFZfTUFKT1I7CisJdTE2IHZlcl9taW5vciA9IFBWX01JTk9SOwogCiAJcGRwcyA9ICh1NjQgKikm
dmdwdV92cmVnNjRfdCh2Z3B1LCB2Z3RpZl9yZWcocGRwWzBdKSk7CiAKQEAgLTEyMjUsNiArMTIz
MCwxOSBAQCBzdGF0aWMgaW50IGhhbmRsZV9nMnZfbm90aWZpY2F0aW9uKHN0cnVjdCBpbnRlbF92
Z3B1ICp2Z3B1LCBpbnQgbm90aWZpY2F0aW9uKQogCWNhc2UgVkdUX0cyVl9QUEdUVF9MM19QQUdF
X1RBQkxFX0RFU1RST1k6CiAJY2FzZSBWR1RfRzJWX1BQR1RUX0w0X1BBR0VfVEFCTEVfREVTVFJP
WToKIAkJcmV0dXJuIGludGVsX3ZncHVfcHV0X3BwZ3R0X21tKHZncHUsIHBkcHMpOworCWNhc2Ug
VkdUX0cyVl9TSEFSRURfUEFHRV9TRVRVUDoKKwkJZ3BhID0gdmdwdV92cmVnNjRfdCh2Z3B1LCB2
Z3RpZl9yZWcoc2hhcmVkX3BhZ2VfZ3BhKSk7CisJCWdmbiA9IGdwYSA+PiBQQUdFX1NISUZUOwor
CQlpZiAoIWludGVsX2d2dF9oeXBlcnZpc29yX2lzX3ZhbGlkX2dmbih2Z3B1LCBnZm4pKSB7CisJ
CQl2Z3B1X3ZyZWdfdCh2Z3B1LCB2Z3RpZl9yZWcocHZfY2FwcykpID0gMDsKKwkJCXJldHVybiAw
OworCQl9CisJCXZncHUtPnNoYXJlZF9wYWdlX2dwYSA9IGdwYTsKKwkJdmdwdS0+c2hhcmVkX3Bh
Z2VfZW5hYmxlZCA9IHRydWU7CisKKwkJaW50ZWxfZ3Z0X3dyaXRlX3NoYXJlZF9wYWdlKHZncHUs
IDAsICZ2ZXJfbWFqb3IsIDIpOworCQlpbnRlbF9ndnRfd3JpdGVfc2hhcmVkX3BhZ2UodmdwdSwg
MiwgJnZlcl9taW5vciwgMik7CisJCWJyZWFrOwogCWNhc2UgVkdUX0cyVl9FWEVDTElTVF9DT05U
RVhUX0NSRUFURToKIAljYXNlIFZHVF9HMlZfRVhFQ0xJU1RfQ09OVEVYVF9ERVNUUk9ZOgogCWNh
c2UgMToJLyogUmVtb3ZlIHRoaXMgaW4gZ3Vlc3QgZHJpdmVyLiAqLwpAQCAtMTI4MSw2ICsxMjk5
LDggQEAgc3RhdGljIGludCBwdmluZm9fbW1pb193cml0ZShzdHJ1Y3QgaW50ZWxfdmdwdSAqdmdw
dSwgdW5zaWduZWQgaW50IG9mZnNldCwKIAljYXNlIF92Z3RpZl9yZWcocGRwWzNdLmhpKToKIAlj
YXNlIF92Z3RpZl9yZWcoZXhlY2xpc3RfY29udGV4dF9kZXNjcmlwdG9yX2xvKToKIAljYXNlIF92
Z3RpZl9yZWcoZXhlY2xpc3RfY29udGV4dF9kZXNjcmlwdG9yX2hpKToKKwljYXNlIF92Z3RpZl9y
ZWcoc2hhcmVkX3BhZ2VfZ3BhKToKKwljYXNlIF92Z3RpZl9yZWcoc2hhcmVkX3BhZ2VfZ3BhKSAr
IDQ6CiAJCWJyZWFrOwogCWNhc2UgX3ZndGlmX3JlZyhyc3Y1WzBdKS4uLl92Z3RpZl9yZWcocnN2
NVszXSk6CiAJCWludmFsaWRfd3JpdGUgPSB0cnVlOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ3Z0L3ZncHUuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d2dC92Z3B1LmMKaW5k
ZXggOWUwMDk3OS4uODExZWRiYiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Z0
L3ZncHUuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQvdmdwdS5jCkBAIC02Myw2ICs2
Myw4IEBAIHZvaWQgcG9wdWxhdGVfcHZpbmZvX3BhZ2Uoc3RydWN0IGludGVsX3ZncHUgKnZncHUp
CiAJdmdwdV92cmVnX3QodmdwdSwgdmd0aWZfcmVnKGN1cnNvcl94X2hvdCkpID0gVUlOVF9NQVg7
CiAJdmdwdV92cmVnX3QodmdwdSwgdmd0aWZfcmVnKGN1cnNvcl95X2hvdCkpID0gVUlOVF9NQVg7
CiAKKwl2Z3B1X3ZyZWc2NF90KHZncHUsIHZndGlmX3JlZyhzaGFyZWRfcGFnZV9ncGEpKSA9IDA7
CisKIAlndnRfZGJnX2NvcmUoIlBvcHVsYXRlIFBWSU5GTyBQQUdFIGZvciB2R1BVICVkXG4iLCB2
Z3B1LT5pZCk7CiAJZ3Z0X2RiZ19jb3JlKCJhcGVydHVyZSBiYXNlIFtHTUFEUl0gMHglbGx4IHNp
emUgMHglbGx4XG4iLAogCQl2Z3B1X2FwZXJ0dXJlX2dtYWRyX2Jhc2UodmdwdSksIHZncHVfYXBl
cnR1cmVfc3oodmdwdSkpOwpAQCAtNTkxLDMgKzU5Myw0NCBAQCB2b2lkIGludGVsX2d2dF9yZXNl
dF92Z3B1KHN0cnVjdCBpbnRlbF92Z3B1ICp2Z3B1KQogCWludGVsX2d2dF9yZXNldF92Z3B1X2xv
Y2tlZCh2Z3B1LCB0cnVlLCAwKTsKIAltdXRleF91bmxvY2soJnZncHUtPnZncHVfbG9jayk7CiB9
CisKKy8qKgorICogaW50ZWxfZ3Z0X3JlYWRfc2hhcmVkX3BhZ2UgLSByZWFkIGNvbnRlbnQgZnJv
bSBzaGFyZWQgcGFnZQorICovCitpbnQgaW50ZWxfZ3Z0X3JlYWRfc2hhcmVkX3BhZ2Uoc3RydWN0
IGludGVsX3ZncHUgKnZncHUsCisJCXVuc2lnbmVkIGludCBvZmZzZXQsIHZvaWQgKmJ1ZiwgdW5z
aWduZWQgbG9uZyBsZW4pCit7CisJaW50IHJldCA9IC1FSU5WQUw7CisJdW5zaWduZWQgbG9uZyBn
cGE7CisKKwlpZiAob2Zmc2V0ID49IFBBR0VfU0laRSkKKwkJZ290byBlcnI7CisKKwlncGEgPSB2
Z3B1LT5zaGFyZWRfcGFnZV9ncGEgKyBvZmZzZXQ7CisJcmV0ID0gaW50ZWxfZ3Z0X2h5cGVydmlz
b3JfcmVhZF9ncGEodmdwdSwgZ3BhLCBidWYsIGxlbik7CisJaWYgKCFyZXQpCisJCXJldHVybiBy
ZXQ7CitlcnI6CisJZ3Z0X3ZncHVfZXJyKCJyZWFkIHNoYXJlZCBwYWdlIChvZmZzZXQgJXgpIGZh
aWxlZCIsIG9mZnNldCk7CisJbWVtc2V0KGJ1ZiwgMCwgbGVuKTsKKwlyZXR1cm4gcmV0OworfQor
CitpbnQgaW50ZWxfZ3Z0X3dyaXRlX3NoYXJlZF9wYWdlKHN0cnVjdCBpbnRlbF92Z3B1ICp2Z3B1
LAorCQl1bnNpZ25lZCBpbnQgb2Zmc2V0LCB2b2lkICpidWYsIHVuc2lnbmVkIGxvbmcgbGVuKQor
eworCWludCByZXQgPSAtRUlOVkFMOworCXVuc2lnbmVkIGxvbmcgZ3BhOworCisJaWYgKG9mZnNl
dCA+PSBQQUdFX1NJWkUpCisJCWdvdG8gZXJyOworCisJZ3BhID0gdmdwdS0+c2hhcmVkX3BhZ2Vf
Z3BhICsgb2Zmc2V0OworCXJldCA9IGludGVsX2d2dF9oeXBlcnZpc29yX3dyaXRlX2dwYSh2Z3B1
LCBncGEsIGJ1ZiwgbGVuKTsKKwlpZiAoIXJldCkKKwkJcmV0dXJuIHJldDsKK2VycjoKKwlndnRf
dmdwdV9lcnIoIndyaXRlIHNoYXJlZCBwYWdlIChvZmZzZXQgJXgpIGZhaWxlZCIsIG9mZnNldCk7
CisJbWVtc2V0KGJ1ZiwgMCwgbGVuKTsKKwlyZXR1cm4gcmV0OworfQotLSAKMS44LjMuMQoKX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KaW50ZWwtZ3Z0LWRl
diBtYWlsaW5nIGxpc3QKaW50ZWwtZ3Z0LWRldkBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6
Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9pbnRlbC1ndnQtZGV2
