Return-Path: <intel-gvt-dev-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gvt-dev@lfdr.de
Delivered-To: lists+intel-gvt-dev@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 95B6FDAA5
	for <lists+intel-gvt-dev@lfdr.de>; Mon, 29 Apr 2019 05:11:39 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 64E8589135;
	Mon, 29 Apr 2019 03:11:38 +0000 (UTC)
X-Original-To: intel-gvt-dev@lists.freedesktop.org
Delivered-To: intel-gvt-dev@lists.freedesktop.org
Received: from mga07.intel.com (mga07.intel.com [134.134.136.100])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 9812789142;
 Mon, 29 Apr 2019 03:11:37 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
 by orsmga105.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 28 Apr 2019 20:11:37 -0700
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.60,408,1549958400"; d="scan'208";a="146648231"
Received: from xzhan34-mobl3.bj.intel.com ([10.238.154.121])
 by fmsmga007.fm.intel.com with ESMTP; 28 Apr 2019 20:11:35 -0700
From: Xiaolin Zhang <xiaolin.zhang@intel.com>
To: intel-gvt-dev@lists.freedesktop.org,
	intel-gfx@lists.freedesktop.org
Subject: [PATCH v5 4/8] drm/i915: vgpu context submission pv optimization
Date: Mon, 29 Apr 2019 11:10:54 +0800
Message-Id: <1556507458-24684-5-git-send-email-xiaolin.zhang@intel.com>
X-Mailer: git-send-email 2.7.4
In-Reply-To: <1556507458-24684-1-git-send-email-xiaolin.zhang@intel.com>
References: <1556507458-24684-1-git-send-email-xiaolin.zhang@intel.com>
MIME-Version: 1.0
X-BeenThere: intel-gvt-dev@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: "Intel GVT \(Graphics Virtualization\) development list"
 <intel-gvt-dev.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gvt-dev>, 
 <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gvt-dev>
List-Post: <mailto:intel-gvt-dev@lists.freedesktop.org>
List-Help: <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gvt-dev>, 
 <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=subscribe>
Cc: Xiaolin Zhang <xiaolin.zhang@intel.com>, zhenyu.z.wang@intel.com,
 joonas.lahtinen@linux.intel.com, hang.yuan@intel.com, min.he@intel.com,
 zhiyuan.lv@intel.com, chris@chris-wilson.co.uk, zhi.a.wang@intel.com
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gvt-dev-bounces@lists.freedesktop.org
Sender: "intel-gvt-dev" <intel-gvt-dev-bounces@lists.freedesktop.org>

SXQgaXMgcGVyZm9ybWFuY2Ugb3B0aW1pemF0aW9uIHRvIG92ZXJyaWRlIHRoZSBhY3R1YWwgc3Vi
bWlzaXNvbiBiYWNrZW5kCmluIG9yZGVyIHRvIGVsaW1pbmF0ZSBleGVjbGlzdHMgY3NiIHByb2Nl
c3MgYW5kIHJlZHVjZSBtbWlvIHRyYXAgbnVtYmVycwpmb3Igd29ya2xvYWQgc3VibWlzc2lvbiB3
aXRob3V0IGNvbnRleHQgc3dpdGNoIGludGVycnVwdCBieSB0YWxraW5nIHdpdGgKR1ZUIHZpYSBQ
ViBzdWJtaXNpc29uIG5vdGlmaWNhdGlvbiBtZWNoYW5pc20gYmV0d2VlbiBndWVzdCBhbmQgR1ZU
LgoKVXNlIFBWX1NVQk1JU1NJT04gdG8gY29udHJvbCB0aGlzIGxldmVsIG9mIHB2IG9wdGltaXph
dGlvbi4KCnYwOiBSRkMKdjE6IHJlYmFzZQp2MjogYWRkZWQgcHYgb3BzIGZvciBwdiBjb250ZXh0
IHN1Ym1pc3Npb24uIHRvIG1heGltaXplIGNvZGUgcmVzdXNlLAppbnRyb2R1Y2VkIDIgbW9yZSBv
cHMgKHN1Ym1pdF9wb3J0cyAmIHByZWVtcHRfY29udGV4dCkgaW5zdGVhZCBvZiAxIG9wCihzZXRf
ZGVmYXVsdF9zdWJtaXNzaW9uKSBpbiBlbmdpbmUgc3RydWN0dXJlLiBwdiB2ZXJzaW9uIG9mCnN1
Ym1pdF9wb3J0cyBhbmQgcHJlZW1wdF9jb250ZXh0IGltcGxlbWVudGVkLgp2MzoKMS4gdG8gcmVk
dWNlIG1vcmUgY29kZSBkdXBsaWNhdGlvbiwgY29kZSByZWZhY3RvciBhbmQgcmVwbGFjZWQgMiBv
cHMKInN1Ym1pdF9wb3J0cyAmIHByZWVtcHRfY29udGV4IiBmcm9tIHYyIGJ5IDEgb3BzICJ3cml0
ZV9kZXNjIgppbiBlbmdpbmUgc3RydWN0dXJlLiBwdiB2ZXJzaW9uIG9mIHdyaXRlX2RlcyBpbXBs
ZW1lbnRlZC4KMi4gYWRkZWQgVkdUX0cyVl9FTFNQX1NVQk1JVCBmb3IgZzJ2IHB2IG5vdGlmaWNh
dGlvbi4KdjQ6IGltcGxlbWVudGVkIHB2IGVsc3Agc3VibWlzc2lvbiB0YXNrbGV0IGFzIHRoZSBi
YWNrZW5kIHdvcmtsb2FkCnN1Ym1pc2lzb24gYnkgdGFsa2luZyB0byBHVlQgd2l0aCBQViBub3Rp
ZmljYWl0b24gbWVjaGFuaXNtIGFuZCByZW5hbWVkClZHVF9HMlZfRUxTUF9TVUJNSVQgdG8gVkdU
X0cyVl9QVl9TVUJNSVNJSU9OLgp2NTogYWRkcmVzc2VkIHY0IGNvbW1lbnRzIGZyb20gQ2hyaXMs
IGludGVsX3B2X3N1Ym1pc3Npb24uYyBhZGRlZC4KClNpZ25lZC1vZmYtYnk6IFhpYW9saW4gWmhh
bmcgPHhpYW9saW4uemhhbmdAaW50ZWwuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L01h
a2VmaWxlICAgICAgICAgICAgICB8ICAgMiArLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50
ZWxfbHJjLmMgICAgICAgIHwgICA4ICstCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3B2aW5m
by5oICAgICAgICAgfCAgIDEgKwogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV92Z3B1LmMgICAg
ICAgICAgIHwgICA4ICstCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ZncHUuaCAgICAgICAg
ICAgfCAgIDMgKwogZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfcHZfc3VibWlzc2lvbi5jIHwg
MTc3ICsrKysrKysrKysrKysrKysrKysrKysrKysrKysrCiA2IGZpbGVzIGNoYW5nZWQsIDE5NSBp
bnNlcnRpb25zKCspLCA0IGRlbGV0aW9ucygtKQogY3JlYXRlIG1vZGUgMTAwNjQ0IGRyaXZlcnMv
Z3B1L2RybS9pOTE1L2ludGVsX3B2X3N1Ym1pc3Npb24uYwoKZGlmZiAtLWdpdCBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L01ha2VmaWxlIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvTWFrZWZpbGUKaW5k
ZXggZGQ4ZDkyMy4uMjc4NzNjNyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvTWFr
ZWZpbGUKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvTWFrZWZpbGUKQEAgLTE5OCw3ICsxOTgs
NyBAQCBpOTE1LSQoQ09ORklHX0RSTV9JOTE1X1NFTEZURVNUKSArPSBcCiAJc2VsZnRlc3RzL2ln
dF9zcGlubmVyLm8KIAogIyB2aXJ0dWFsIGdwdSBjb2RlCi1pOTE1LXkgKz0gaTkxNV92Z3B1Lm8K
K2k5MTUteSArPSBpOTE1X3ZncHUubyBpbnRlbF9wdl9zdWJtaXNzaW9uLm8KIAogIyBwZXJmIGNv
ZGUKIGk5MTUteSArPSBpOTE1X3BlcmYubyBcCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9ndC9pbnRlbF9scmMuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2xyYy5j
CmluZGV4IGQxN2MwOGUuLmQzMWE5OGIgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2d0L2ludGVsX2xyYy5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2xyYy5j
CkBAIC0yMzgwLDExICsyMzgwLDE1IEBAIHZvaWQgaW50ZWxfZXhlY2xpc3RzX3NldF9kZWZhdWx0
X3N1Ym1pc3Npb24oc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKQogCWVuZ2luZS0+dW5w
YXJrID0gTlVMTDsKIAogCWVuZ2luZS0+ZmxhZ3MgfD0gSTkxNV9FTkdJTkVfU1VQUE9SVFNfU1RB
VFM7Ci0JaWYgKCFpbnRlbF92Z3B1X2FjdGl2ZShlbmdpbmUtPmk5MTUpKQotCQllbmdpbmUtPmZs
YWdzIHw9IEk5MTVfRU5HSU5FX0hBU19TRU1BUEhPUkVTOworCWVuZ2luZS0+ZmxhZ3MgfD0gSTkx
NV9FTkdJTkVfSEFTX1NFTUFQSE9SRVM7CiAJaWYgKGVuZ2luZS0+cHJlZW1wdF9jb250ZXh0ICYm
CiAJICAgIEhBU19MT0dJQ0FMX1JJTkdfUFJFRU1QVElPTihlbmdpbmUtPmk5MTUpKQogCQllbmdp
bmUtPmZsYWdzIHw9IEk5MTVfRU5HSU5FX0hBU19QUkVFTVBUSU9OOworCisJaWYgKGludGVsX3Zn
cHVfYWN0aXZlKGVuZ2luZS0+aTkxNSkpIHsKKwkJZW5naW5lLT5mbGFncyAmPSB+STkxNV9FTkdJ
TkVfSEFTX1NFTUFQSE9SRVM7CisJCWludGVsX3ZncHVfY29uZmlnX3B2X2NhcHMoZW5naW5lLT5p
OTE1LAlQVl9TVUJNSVNTSU9OLCBlbmdpbmUpOworCX0KIH0KIAogc3RhdGljIHZvaWQKZGlmZiAt
LWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcHZpbmZvLmggYi9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9pOTE1X3B2aW5mby5oCmluZGV4IDI0MDhhOWQuLjM2MmQ4OTggMTAwNjQ0Ci0tLSBh
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfcHZpbmZvLmgKKysrIGIvZHJpdmVycy9ncHUvZHJt
L2k5MTUvaTkxNV9wdmluZm8uaApAQCAtNTAsNiArNTAsNyBAQCBlbnVtIHZndF9nMnZfdHlwZSB7
CiAJVkdUX0cyVl9QUEdUVF9MNF9BTExPQywKIAlWR1RfRzJWX1BQR1RUX0w0X0NMRUFSLAogCVZH
VF9HMlZfUFBHVFRfTDRfSU5TRVJULAorCVZHVF9HMlZfUFZfU1VCTUlTU0lPTiwKIAlWR1RfRzJW
X01BWCwKIH07CiAKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfdmdwdS5j
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV92Z3B1LmMKaW5kZXggMjM4MTRjZC4uOGRlYTBi
NyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV92Z3B1LmMKKysrIGIvZHJp
dmVycy9ncHUvZHJtL2k5MTUvaTkxNV92Z3B1LmMKQEAgLTgxLDcgKzgxLDcgQEAgdm9pZCBpOTE1
X2NoZWNrX3ZncHUoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2KQogCWRldl9wcml2
LT52Z3B1LmFjdGl2ZSA9IHRydWU7CiAKIAkvKiBndWVzdCBkcml2ZXIgUFYgY2FwYWJpbGl0eSAq
LwotCWRldl9wcml2LT52Z3B1LnB2X2NhcHMgPSBQVl9QUEdUVF9VUERBVEU7CisJZGV2X3ByaXYt
PnZncHUucHZfY2FwcyA9IFBWX1BQR1RUX1VQREFURSB8IFBWX1NVQk1JU1NJT047CiAKIAlpZiAo
IWludGVsX3ZncHVfY2hlY2tfcHZfY2FwcyhkZXZfcHJpdikpIHsKIAkJRFJNX0lORk8oIlZpcnR1
YWwgR1BVIGZvciBJbnRlbCBHVlQtZyBkZXRlY3RlZC5cbiIpOwpAQCAtMzYxLDYgKzM2MSw3IEBA
IHZvaWQgaW50ZWxfdmdwdV9jb25maWdfcHZfY2FwcyhzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0ZSAq
ZGV2X3ByaXYsCiAJCWVudW0gcHZfY2FwcyBjYXAsIHZvaWQgKmRhdGEpCiB7CiAJc3RydWN0IGk5
MTVfaHdfcHBndHQgKnBwZ3R0OworCXN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZTsKIAog
CWlmICghaW50ZWxfdmdwdV9lbmFibGVkX3B2X2NhcHMoZGV2X3ByaXYsIGNhcCkpCiAJCXJldHVy
bjsKQEAgLTM3MSw2ICszNzIsMTEgQEAgdm9pZCBpbnRlbF92Z3B1X2NvbmZpZ19wdl9jYXBzKHN0
cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiwKIAkJcHBndHQtPnZtLmluc2VydF9lbnRy
aWVzID0gZ2VuOF9wcGd0dF9pbnNlcnRfNGx2bF9wdjsKIAkJcHBndHQtPnZtLmNsZWFyX3Jhbmdl
ID0gZ2VuOF9wcGd0dF9jbGVhcl80bHZsX3B2OwogCX0KKworCWlmIChjYXAgPT0gUFZfU1VCTUlT
U0lPTikgeworCQllbmdpbmUgPSAoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqKWRhdGE7CisJCXZn
cHVfc2V0X3B2X3N1Ym1pc3Npb24oZW5naW5lKTsKKwl9CiB9CiAKIC8qCmRpZmYgLS1naXQgYS9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ZncHUuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5
MTVfdmdwdS5oCmluZGV4IDZiY2U4YTUuLmY0ZThhMWUgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L2k5MTVfdmdwdS5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfdmdw
dS5oCkBAIC0zMSw2ICszMSw3IEBACiAgKi8KIGVudW0gcHZfY2FwcyB7CiAJUFZfUFBHVFRfVVBE
QVRFID0gMHgxLAorCVBWX1NVQk1JU1NJT04gPSAweDIsCiB9OwogCiAvKgpAQCAtOTAsNCArOTEs
NiBAQCB2b2lkIGludGVsX3ZndF9kZWJhbGxvb24oc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRl
dl9wcml2KTsKIGJvb2wgaW50ZWxfdmdwdV9jaGVja19wdl9jYXBzKHN0cnVjdCBkcm1faTkxNV9w
cml2YXRlICpkZXZfcHJpdik7CiB2b2lkIGludGVsX3ZncHVfY29uZmlnX3B2X2NhcHMoc3RydWN0
IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2LAogCQllbnVtIHB2X2NhcHMgY2FwLCB2b2lkICpk
YXRhKTsKK3ZvaWQgdmdwdV9zZXRfcHZfc3VibWlzc2lvbihzdHJ1Y3QgaW50ZWxfZW5naW5lX2Nz
ICplbmdpbmUpOworCiAjZW5kaWYgLyogX0k5MTVfVkdQVV9IXyAqLwpkaWZmIC0tZ2l0IGEvZHJp
dmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfcHZfc3VibWlzc2lvbi5jIGIvZHJpdmVycy9ncHUvZHJt
L2k5MTUvaW50ZWxfcHZfc3VibWlzc2lvbi5jCm5ldyBmaWxlIG1vZGUgMTAwNjQ0CmluZGV4IDAw
MDAwMDAuLjNiYTljODIKLS0tIC9kZXYvbnVsbAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9p
bnRlbF9wdl9zdWJtaXNzaW9uLmMKQEAgLTAsMCArMSwxNzcgQEAKKy8vIFNQRFgtTGljZW5zZS1J
ZGVudGlmaWVyOiBNSVQKKy8qCisgKiBDb3B5cmlnaHQgwqkgMjAxOCBJbnRlbCBDb3Jwb3JhdGlv
bgorICovCisKKyNpbmNsdWRlICJpbnRlbF9kcnYuaCIKKyNpbmNsdWRlICJpOTE1X3ZncHUuaCIK
KyNpbmNsdWRlICJndC9pbnRlbF9scmNfcmVnLmgiCisKK3N0YXRpYyB1NjQgZXhlY2xpc3RzX3Vw
ZGF0ZV9jb250ZXh0KHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxKQoreworCXN0cnVjdCBpbnRlbF9j
b250ZXh0ICpjZSA9IHJxLT5od19jb250ZXh0OworCXUzMiAqcmVnX3N0YXRlID0gY2UtPmxyY19y
ZWdfc3RhdGU7CisKKwlyZWdfc3RhdGVbQ1RYX1JJTkdfVEFJTCsxXSA9IGludGVsX3Jpbmdfc2V0
X3RhaWwocnEtPnJpbmcsIHJxLT50YWlsKTsKKworCXJldHVybiBjZS0+bHJjX2Rlc2M7Cit9CisK
K3N0YXRpYyBpbmxpbmUgc3RydWN0IGk5MTVfcHJpb2xpc3QgKnRvX3ByaW9saXN0KHN0cnVjdCBy
Yl9ub2RlICpyYikKK3sKKwlyZXR1cm4gcmJfZW50cnkocmIsIHN0cnVjdCBpOTE1X3ByaW9saXN0
LCBub2RlKTsKK30KKworc3RhdGljIHZvaWQgcHZfc3VibWl0KHN0cnVjdCBpbnRlbF9lbmdpbmVf
Y3MgKmVuZ2luZSkKK3sKKwlzdHJ1Y3QgaW50ZWxfZW5naW5lX2V4ZWNsaXN0cyAqIGNvbnN0IGV4
ZWNsaXN0cyA9ICZlbmdpbmUtPmV4ZWNsaXN0czsKKwlzdHJ1Y3QgZXhlY2xpc3RfcG9ydCAqcG9y
dCA9IGV4ZWNsaXN0cy0+cG9ydDsKKwl1bnNpZ25lZCBpbnQgbjsKKwlzdHJ1Y3QgZ3Z0X3NoYXJl
ZF9wYWdlICpzaGFyZWRfcGFnZSA9IGVuZ2luZS0+aTkxNS0+dmdwdS5zaGFyZWRfcGFnZTsKKwl1
NjQgZGVzY3NbMl07CisKKwlmb3IgKG4gPSAwOyBuIDwgZXhlY2xpc3RzX251bV9wb3J0cyhleGVj
bGlzdHMpOyBuKyspIHsKKwkJc3RydWN0IGk5MTVfcmVxdWVzdCAqcnE7CisJCXVuc2lnbmVkIGlu
dCBjb3VudCA9IDA7CisKKwkJZGVzY3Nbbl0gPSAwOworCQlycSA9IHBvcnRfdW5wYWNrKCZwb3J0
W25dLCAmY291bnQpOworCQlpZiAocnEgJiYgY291bnQgPT0gMCkgeworCQkJcG9ydF9zZXQoJnBv
cnRbbl0sIHBvcnRfcGFjayhycSwgKytjb3VudCkpOworCQkJZGVzY3Nbbl0gPSBleGVjbGlzdHNf
dXBkYXRlX2NvbnRleHQocnEpOworCQl9CisJfQorCisJc3Bpbl9sb2NrKCZlbmdpbmUtPmk5MTUt
PnZncHUuc2hhcmVkX3BhZ2VfbG9ja1tlbmdpbmUtPmlkXSk7CisJZm9yIChuID0gMDsgbiA8IGV4
ZWNsaXN0c19udW1fcG9ydHMoZXhlY2xpc3RzKTsgbisrKQorCQlzaGFyZWRfcGFnZS0+cHZfZWxz
cFtlbmdpbmUtPmlkXS5kZXNjc1tuXSA9IGRlc2NzW25dOworCisJd3JpdGVsKFZHVF9HMlZfUFZf
U1VCTUlTU0lPTiwgZXhlY2xpc3RzLT5zdWJtaXRfcmVnKTsKKwlzcGluX3VubG9jaygmZW5naW5l
LT5pOTE1LT52Z3B1LnNoYXJlZF9wYWdlX2xvY2tbZW5naW5lLT5pZF0pOworfQorCitzdGF0aWMg
aW5saW5lIGludCBycV9wcmlvKGNvbnN0IHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxKQoreworCXJl
dHVybiBycS0+c2NoZWQuYXR0ci5wcmlvcml0eTsKK30KKworc3RhdGljIGlubGluZSBpbnQgcG9y
dF9wcmlvKGNvbnN0IHN0cnVjdCBleGVjbGlzdF9wb3J0ICpwb3J0KQoreworCXJldHVybiBycV9w
cmlvKHBvcnRfcmVxdWVzdChwb3J0KSkgfCBfX05PX1BSRUVNUFRJT047Cit9CisKK3N0YXRpYyB2
b2lkIHB2X2RlcXVldWUoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKQoreworCXN0cnVj
dCBpbnRlbF9lbmdpbmVfZXhlY2xpc3RzICogY29uc3QgZXhlY2xpc3RzID0gJmVuZ2luZS0+ZXhl
Y2xpc3RzOworCXN0cnVjdCBleGVjbGlzdF9wb3J0ICpwb3J0ID0gZXhlY2xpc3RzLT5wb3J0Owor
CXN0cnVjdCBpOTE1X3JlcXVlc3QgKmxhc3QgPSBOVUxMOworCWJvb2wgc3VibWl0ID0gZmFsc2U7
CisJc3RydWN0IHJiX25vZGUgKnJiOworCisJbG9ja2RlcF9hc3NlcnRfaGVsZCgmZW5naW5lLT50
aW1lbGluZS5sb2NrKTsKKworCXdoaWxlICgocmIgPSByYl9maXJzdF9jYWNoZWQoJmV4ZWNsaXN0
cy0+cXVldWUpKSkgeworCQlzdHJ1Y3QgaTkxNV9wcmlvbGlzdCAqcCA9IHRvX3ByaW9saXN0KHJi
KTsKKwkJc3RydWN0IGk5MTVfcmVxdWVzdCAqcnEsICpybjsKKwkJaW50IGk7CisKKwkJcHJpb2xp
c3RfZm9yX2VhY2hfcmVxdWVzdF9jb25zdW1lKHJxLCBybiwgcCwgaSkgeworCQkJaWYgKGxhc3Qg
JiYgcnEtPmh3X2NvbnRleHQgIT0gbGFzdC0+aHdfY29udGV4dCkKKwkJCQlnb3RvIGRvbmU7CisK
KwkJCWxpc3RfZGVsX2luaXQoJnJxLT5zY2hlZC5saW5rKTsKKworCQkJX19pOTE1X3JlcXVlc3Rf
c3VibWl0KHJxKTsKKwkJCXRyYWNlX2k5MTVfcmVxdWVzdF9pbihycSwgcG9ydF9pbmRleChwb3J0
LCBleGVjbGlzdHMpKTsKKworCQkJbGFzdCA9IHJxOworCQkJc3VibWl0ID0gdHJ1ZTsKKwkJfQor
CisJCXJiX2VyYXNlX2NhY2hlZCgmcC0+bm9kZSwgJmV4ZWNsaXN0cy0+cXVldWUpOworCQlpOTE1
X3ByaW9saXN0X2ZyZWUocCk7CisJfQorZG9uZToKKwlleGVjbGlzdHMtPnF1ZXVlX3ByaW9yaXR5
X2hpbnQgPQorCQkJcmIgPyB0b19wcmlvbGlzdChyYiktPnByaW9yaXR5IDogSU5UX01JTjsKKwlp
ZiAoc3VibWl0KSB7CisJCXBvcnRfc2V0KHBvcnQsIGk5MTVfcmVxdWVzdF9nZXQobGFzdCkpOwor
CQlwdl9zdWJtaXQoZW5naW5lKTsKKwl9CisJaWYgKGxhc3QpCisJCWV4ZWNsaXN0c191c2VyX2Jl
Z2luKGV4ZWNsaXN0cywgZXhlY2xpc3RzLT5wb3J0KTsKKworCS8qIFdlIG11c3QgYWx3YXlzIGtl
ZXAgdGhlIGJlYXN0IGZlZCBpZiB3ZSBoYXZlIHdvcmsgcGlsZWQgdXAgKi8KKwlHRU1fQlVHX09O
KHBvcnRfaXNzZXQoZXhlY2xpc3RzLT5wb3J0KSAmJgorCQkgICAhZXhlY2xpc3RzX2lzX2FjdGl2
ZShleGVjbGlzdHMsIEVYRUNMSVNUU19BQ1RJVkVfVVNFUikpOworCUdFTV9CVUdfT04ocmJfZmly
c3RfY2FjaGVkKCZleGVjbGlzdHMtPnF1ZXVlKSAmJgorCQkgICAhcG9ydF9pc3NldChleGVjbGlz
dHMtPnBvcnQpKTsKK30KKworc3RhdGljIHZvaWQgdmdwdV9wdl9zdWJtaXNzaW9uX3Rhc2tsZXQo
dW5zaWduZWQgbG9uZyBkYXRhKQoreworCXN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKiBjb25zdCBl
bmdpbmUgPSAoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqKWRhdGE7CisJc3RydWN0IGludGVsX2Vu
Z2luZV9leGVjbGlzdHMgKiBjb25zdCBleGVjbGlzdHMgPSAmZW5naW5lLT5leGVjbGlzdHM7CisJ
c3RydWN0IGV4ZWNsaXN0X3BvcnQgKnBvcnQgPSBleGVjbGlzdHMtPnBvcnQ7CisJc3RydWN0IGk5
MTVfcmVxdWVzdCAqcnE7CisJdW5zaWduZWQgbG9uZyBmbGFnczsKKwlib29sIHJxX2ZpbmlzaGVk
ID0gZmFsc2U7CisKKwlzcGluX2xvY2tfaXJxc2F2ZSgmZW5naW5lLT50aW1lbGluZS5sb2NrLCBm
bGFncyk7CisKKwlycSA9IHBvcnRfcmVxdWVzdChwb3J0KTsKKwl3aGlsZSAocnEgJiYgaTkxNV9y
ZXF1ZXN0X2NvbXBsZXRlZChycSkpIHsKKwkJdHJhY2VfaTkxNV9yZXF1ZXN0X291dChycSk7CisJ
CXJxX2ZpbmlzaGVkID0gdHJ1ZTsKKwkJaTkxNV9yZXF1ZXN0X3B1dChycSk7CisKKwkJcG9ydCA9
IGV4ZWNsaXN0c19wb3J0X2NvbXBsZXRlKGV4ZWNsaXN0cywgcG9ydCk7CisJCWlmIChwb3J0X2lz
c2V0KHBvcnQpKSB7CisJCQlycV9maW5pc2hlZCA9IGZhbHNlOworCQkJZXhlY2xpc3RzX3VzZXJf
YmVnaW4oZXhlY2xpc3RzLCBwb3J0KTsKKwkJCXJxID0gcG9ydF9yZXF1ZXN0KHBvcnQpOworCQl9
IGVsc2UgeworCQkJZXhlY2xpc3RzX3VzZXJfZW5kKGV4ZWNsaXN0cyk7CisJCQlycSA9IE5VTEw7
CisJCX0KKwl9CisKKwlpZiAocnFfZmluaXNoZWQgfHwgIXJxKQorCQlwdl9kZXF1ZXVlKGVuZ2lu
ZSk7CisKKwlzcGluX3VubG9ja19pcnFyZXN0b3JlKCZlbmdpbmUtPnRpbWVsaW5lLmxvY2ssIGZs
YWdzKTsKK30KKworc3RhdGljIHZvaWQgdmdwdV9wdl9zdWJtaXNzaW9uX3Bhcmsoc3RydWN0IGlu
dGVsX2VuZ2luZV9jcyAqZW5naW5lKQoreworCWludGVsX2VuZ2luZV91bnBpbl9icmVhZGNydW1i
c19pcnEoZW5naW5lKTsKKwllbmdpbmUtPmZsYWdzICY9IH5JOTE1X0VOR0lORV9ORUVEU19CUkVB
RENSVU1CX1RBU0tMRVQ7Cit9CisKK3N0YXRpYyB2b2lkIHZncHVfcHZfc3VibWlzc2lvbl91bnBh
cmsoc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lKQoreworCWVuZ2luZS0+ZmxhZ3MgfD0g
STkxNV9FTkdJTkVfTkVFRFNfQlJFQURDUlVNQl9UQVNLTEVUOworCWludGVsX2VuZ2luZV9waW5f
YnJlYWRjcnVtYnNfaXJxKGVuZ2luZSk7Cit9CisKK3ZvaWQgdmdwdV9zZXRfcHZfc3VibWlzc2lv
bihzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUpCit7CisJLyoKKwkgKiBXZSBpbmhlcml0
IGEgYnVuY2ggb2YgZnVuY3Rpb25zIGZyb20gZXhlY2xpc3RzIHRoYXQgd2UnZCBsaWtlCisJICog
dG8ga2VlcCB1c2luZzoKKwkgKgorCSAqICAgIGVuZ2luZS0+c3VibWl0X3JlcXVlc3QgPSBleGVj
bGlzdHNfc3VibWl0X3JlcXVlc3Q7CisJICogICAgZW5naW5lLT5jYW5jZWxfcmVxdWVzdHMgPSBl
eGVjbGlzdHNfY2FuY2VsX3JlcXVlc3RzOworCSAqICAgIGVuZ2luZS0+c2NoZWR1bGUgPSBleGVj
bGlzdHNfc2NoZWR1bGU7CisJICoKKwkgKiBCdXQgd2UgbmVlZCB0byBvdmVycmlkZSB0aGUgYWN0
dWFsIHN1Ym1pc3Npb24gYmFja2VuZCBpbiBvcmRlcgorCSAqIHRvIHRhbGsgdG8gdGhlIEdWVCB3
aXRoIFBWIG5vdGlmaWNhdGlvbiBtZXNzYWdlLgorCSAqLworCisJZW5naW5lLT5leGVjbGlzdHMu
dGFza2xldC5mdW5jID0gdmdwdV9wdl9zdWJtaXNzaW9uX3Rhc2tsZXQ7CisKKwllbmdpbmUtPnBh
cmsgPSB2Z3B1X3B2X3N1Ym1pc3Npb25fcGFyazsKKwllbmdpbmUtPnVucGFyayA9IHZncHVfcHZf
c3VibWlzc2lvbl91bnBhcms7CisKKwllbmdpbmUtPmZsYWdzICY9IH5JOTE1X0VOR0lORV9IQVNf
UFJFRU1QVElPTjsKK30KLS0gCjIuNy40CgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fXwppbnRlbC1ndnQtZGV2IG1haWxpbmcgbGlzdAppbnRlbC1ndnQtZGV2
QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWls
bWFuL2xpc3RpbmZvL2ludGVsLWd2dC1kZXY=
