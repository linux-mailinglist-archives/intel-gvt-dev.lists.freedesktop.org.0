Return-Path: <intel-gvt-dev-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gvt-dev@lfdr.de
Delivered-To: lists+intel-gvt-dev@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id A211A8F906
	for <lists+intel-gvt-dev@lfdr.de>; Fri, 16 Aug 2019 04:35:54 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 640B26EAB1;
	Fri, 16 Aug 2019 02:35:53 +0000 (UTC)
X-Original-To: intel-gvt-dev@lists.freedesktop.org
Delivered-To: intel-gvt-dev@lists.freedesktop.org
Received: from mga02.intel.com (mga02.intel.com [134.134.136.20])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 6E1AB6EAB1
 for <intel-gvt-dev@lists.freedesktop.org>;
 Fri, 16 Aug 2019 02:35:52 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from fmsmga001.fm.intel.com ([10.253.24.23])
 by orsmga101.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 15 Aug 2019 19:35:52 -0700
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.64,391,1559545200"; d="scan'208";a="194894854"
Received: from gvt.bj.intel.com ([10.238.158.180])
 by fmsmga001.fm.intel.com with ESMTP; 15 Aug 2019 19:35:50 -0700
From: Tina Zhang <tina.zhang@intel.com>
To: intel-gvt-dev@lists.freedesktop.org
Subject: [PATCH v5 4/6] drm/i915/gvt: Deliver vGPU refresh event to userspace
Date: Fri, 16 Aug 2019 10:35:26 +0800
Message-Id: <20190816023528.30210-5-tina.zhang@intel.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20190816023528.30210-1-tina.zhang@intel.com>
References: <20190816023528.30210-1-tina.zhang@intel.com>
X-BeenThere: intel-gvt-dev@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: "Intel GVT \(Graphics Virtualization\) development list"
 <intel-gvt-dev.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gvt-dev>, 
 <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gvt-dev>
List-Post: <mailto:intel-gvt-dev@lists.freedesktop.org>
List-Help: <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gvt-dev>, 
 <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=subscribe>
Cc: kvm@vger.kernel.org, linux-kernel@vger.kernel.org, hang.yuan@intel.com,
 alex.williamson@redhat.com, kraxel@redhat.com, Kechen Lu <kechen.lu@intel.com>,
 Tina Zhang <tina.zhang@intel.com>, zhiyuan.lv@intel.com
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gvt-dev-bounces@lists.freedesktop.org
Sender: "intel-gvt-dev" <intel-gvt-dev-bounces@lists.freedesktop.org>

RGVsaXZlciB0aGUgZGlzcGxheSByZWZyZXNoIGV2ZW50cyB0byB0aGUgdXNlciBsYW5kLiBVc2Vy
c3BhY2UgY2FuIHVzZQp0aGUgaXJxIG1hc2svdW5tYXNrIG1lY2hhbmlzbSB0byBkaXNhYmxlIG9y
IGVuYWJsZSB0aGUgZXZlbnQgZGVsaXZlcnkuCgpBcyB3ZSBrbm93LCBkZWxpdmVyaW5nIHJlZnJl
c2ggZXZlbnQgYXQgZWFjaCB2Ymxhbmsgc2FmZWx5IGF2b2lkcwp0ZWFyaW5nIGFuZCB1bmV4cGVj
dGVkIGV2ZW50IG92ZXJ3aGVsbWluZywgYnV0IHRoZXJlIGFyZSBzdGlsbCBzcGFjZXMKdG8gb3B0
aW1pemUuCgpGb3IgaGFuZGxpbmcgdGhlIG5vcm1hbCBjYXNlLCBkZWxpdmVyIHRoZSBwYWdlIGZs
aXAgcmVmcmVzaApldmVudCBhdCBlYWNoIHZibGFuaywgaW4gb3RoZXIgd29yZHMsIGJvdW5kZWQg
YnkgdmJsYW5rcy4gU2tpcHBpbmcgc29tZQpldmVudHMgYnJpbmcgcGVyZm9ybWFuY2UgZW5oYW5j
ZW1lbnQgd2hpbGUgbm90IGh1cnRpbmcgdXNlciBleHBlcmllbmNlLgoKRm9yIHNpbmdsZSBmcmFt
ZWJ1ZmZlciBjYXNlLCBkZWxpdmVyIHRoZSByZWZyZXNoIGV2ZW50cyB0byB1c2Vyc3BhY2UgYXQK
YWxsIHZibGFua3MuIFRoaXMgaGV1cmlzdGljIGF0IGVhY2ggdmJsYW5rIGxldmVyYWdlcyBwYWdl
ZmxpcF9jb3VudAppbmNyZXNlbWVudHMgdG8gZGV0ZXJtaW5lIGlmIHRoZXJlIGlzIG5vIHBhZ2Ug
ZmxpcCBoYXBwZW5zIGFmdGVyIGEgY2VydGFpbgpwZXJpb2QgYW5kIHNvIHRoYXQgdGhlIGNhc2Ug
aXMgcmVnYXJkZWQgYXMgc2luZ2xlIGZyYW1lYnVmZmVyIG9uZS4KQWx0aG91Z2ggdGhpcyBoZXVy
aXN0aWMgbWFrZXMgaW5jb3JyZWN0IGRlY2lzaW9uIHNvbWV0aW1lcyBhbmQgaXQgZGVwZW5kcwpv
biBndWVzdCBiZWhhdmlvciwgZm9yIGV4YW1wbGUsIHdoZW4gbm8gY3Vyc29yIG1vdmVtZW50cyBo
YXBwZW4sIHRoZQp1c2VyIGV4cGVyaWVuY2UgZG9lcyBub3QgaGFybSBhbmQgZnJvbnQgYnVmZmVy
IGlzIHN0aWxsIGNvcnJlY3RseSBhY3F1aXJlZC4KTWVhbndoaWxlLCBpbiBhY3R1YWwgc2luZ2xl
IGZyYW1lYnVmZmVyIGNhc2UsIHRoZSB1c2VyIGV4cGVyaWVuY2UgaXMKZW5oYW5jZWQgY29tcGFy
ZWQgd2l0aCBwYWdlIGZsaXAgZXZlbnRzIG9ubHkuCgpBZGR0aW9uYWxseSwgdG8gbWl0aWdhdGUg
dGhlIGV2ZW50cyBkZWxpdmVyaW5nIGZvb3RwcmludHMsIG9uZSBldmVudGZkIGFuZAo4IGJ5dGUg
ZXZlbnRmZCBjb3VudGVyIHBhcnRpdGlvbiBhcmUgbGV2ZXJhZ2VkLgoKdjI6Ci0gU3VwcG9ydCB2
ZmlvX2lycV9pbmZvX2NhcF9kaXNwbGF5X3BsYW5lX2V2ZW50cy4gKFRpbmEpCgpTaWduZWQtb2Zm
LWJ5OiBUaW5hIFpoYW5nIDx0aW5hLnpoYW5nQGludGVsLmNvbT4KU2lnbmVkLW9mZi1ieTogS2Vj
aGVuIEx1IDxrZWNoZW4ubHVAaW50ZWwuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2d2
dC9kaXNwbGF5LmMgfCAgMjIgKysrKwogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Z0L2d2dC5oICAg
ICB8ICAgMiArCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQva3ZtZ3QuYyAgIHwgMTU5ICsrKysr
KysrKysrKysrKysrKysrKysrKysrKy0tCiAzIGZpbGVzIGNoYW5nZWQsIDE3NCBpbnNlcnRpb25z
KCspLCA5IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d2
dC9kaXNwbGF5LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQvZGlzcGxheS5jCmluZGV4IDFh
MGE0YWU0ODI2ZS4uNjE2Mjg1ZTRhMDE0IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9ndnQvZGlzcGxheS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d2dC9kaXNwbGF5LmMK
QEAgLTM0LDYgKzM0LDggQEAKIAogI2luY2x1ZGUgImk5MTVfZHJ2LmgiCiAjaW5jbHVkZSAiZ3Z0
LmgiCisjaW5jbHVkZSA8dWFwaS9saW51eC92ZmlvLmg+CisjaW5jbHVkZSA8ZHJtL2RybV9wbGFu
ZS5oPgogCiBzdGF0aWMgaW50IGdldF9lZHBfcGlwZShzdHJ1Y3QgaW50ZWxfdmdwdSAqdmdwdSkK
IHsKQEAgLTM4Nyw2ICszODksOCBAQCB2b2lkIGludGVsX2d2dF9jaGVja192YmxhbmtfZW11bGF0
aW9uKHN0cnVjdCBpbnRlbF9ndnQgKmd2dCkKIAltdXRleF91bmxvY2soJmd2dC0+bG9jayk7CiB9
CiAKKyNkZWZpbmUgUEFHRUZMSVBfREVMQVlfVEhSIDEwCisKIHN0YXRpYyB2b2lkIGVtdWxhdGVf
dmJsYW5rX29uX3BpcGUoc3RydWN0IGludGVsX3ZncHUgKnZncHUsIGludCBwaXBlKQogewogCXN0
cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiA9IHZncHUtPmd2dC0+ZGV2X3ByaXY7CkBA
IC0zOTYsNyArNDAwLDEwIEBAIHN0YXRpYyB2b2lkIGVtdWxhdGVfdmJsYW5rX29uX3BpcGUoc3Ry
dWN0IGludGVsX3ZncHUgKnZncHUsIGludCBwaXBlKQogCQlbUElQRV9CXSA9IFBJUEVfQl9WQkxB
TkssCiAJCVtQSVBFX0NdID0gUElQRV9DX1ZCTEFOSywKIAl9OworCWludCBwcmlfZmxpcF9ldmVu
dCA9IFNLTF9GTElQX0VWRU5UKHBpcGUsIFBMQU5FX1BSSU1BUlkpOwogCWludCBldmVudDsKKwl1
NjQgZXZlbnRmZF9zaWduYWxfdmFsID0gMDsKKwlzdGF0aWMgaW50IG5vX3BhZ2VmbGlwX2NvdW50
OwogCiAJaWYgKHBpcGUgPCBQSVBFX0EgfHwgcGlwZSA+IFBJUEVfQykKIAkJcmV0dXJuOwpAQCAt
NDA3LDExICs0MTQsMjYgQEAgc3RhdGljIHZvaWQgZW11bGF0ZV92Ymxhbmtfb25fcGlwZShzdHJ1
Y3QgaW50ZWxfdmdwdSAqdmdwdSwgaW50IHBpcGUpCiAJCWlmICghcGlwZV9pc19lbmFibGVkKHZn
cHUsIHBpcGUpKQogCQkJY29udGludWU7CiAKKwkJaWYgKGV2ZW50ID09IHByaV9mbGlwX2V2ZW50
KQorCQkJZXZlbnRmZF9zaWduYWxfdmFsIHw9IERJU1BMQVlfUFJJX1JFRlJFU0hfRVZFTlRfVkFM
OworCiAJCWludGVsX3ZncHVfdHJpZ2dlcl92aXJ0dWFsX2V2ZW50KHZncHUsIGV2ZW50KTsKIAl9
CiAKKwlpZiAoZXZlbnRmZF9zaWduYWxfdmFsKQorCQlub19wYWdlZmxpcF9jb3VudCA9IDA7CisJ
ZWxzZSBpZiAoIWV2ZW50ZmRfc2lnbmFsX3ZhbCAmJiBub19wYWdlZmxpcF9jb3VudCA+IFBBR0VG
TElQX0RFTEFZX1RIUikKKwkJZXZlbnRmZF9zaWduYWxfdmFsIHw9IERJU1BMQVlfUFJJX1JFRlJF
U0hfRVZFTlRfVkFMOworCWVsc2UKKwkJbm9fcGFnZWZsaXBfY291bnQrKzsKKworCWlmICh2Z3B1
LT52ZGV2LnZibGFua190cmlnZ2VyICYmICF2Z3B1LT52ZGV2LmRpc3BsYXlfZXZlbnRfbWFzayAm
JgorCQlldmVudGZkX3NpZ25hbF92YWwpCisJCWV2ZW50ZmRfc2lnbmFsKHZncHUtPnZkZXYudmJs
YW5rX3RyaWdnZXIsIGV2ZW50ZmRfc2lnbmFsX3ZhbCk7CisKIAlpZiAocGlwZV9pc19lbmFibGVk
KHZncHUsIHBpcGUpKSB7CiAJCXZncHVfdnJlZ190KHZncHUsIFBJUEVfRlJNQ09VTlRfRzRYKHBp
cGUpKSsrOworCiAJCWludGVsX3ZncHVfdHJpZ2dlcl92aXJ0dWFsX2V2ZW50KHZncHUsIHZibGFu
a19ldmVudFtwaXBlXSk7CiAJfQogfQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUv
Z3Z0L2d2dC5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Z0L2d2dC5oCmluZGV4IGNkMjllYTI4
ZDdlZC4uNmM4ZWQwMzBjMzBiIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQv
Z3Z0LmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Z0L2d2dC5oCkBAIC0yMDUsNiArMjA1
LDggQEAgc3RydWN0IGludGVsX3ZncHUgewogCQlpbnQgbnVtX2lycXM7CiAJCXN0cnVjdCBldmVu
dGZkX2N0eCAqaW50eF90cmlnZ2VyOwogCQlzdHJ1Y3QgZXZlbnRmZF9jdHggKm1zaV90cmlnZ2Vy
OworCQlzdHJ1Y3QgZXZlbnRmZF9jdHggKnZibGFua190cmlnZ2VyOworCQl1MzIgZGlzcGxheV9l
dmVudF9tYXNrOwogCiAJCS8qCiAJCSAqIFR3byBjYWNoZXMgYXJlIHVzZWQgdG8gYXZvaWQgbWFw
cGluZyBkdXBsaWNhdGVkIHBhZ2VzIChlZy4KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2d2dC9rdm1ndC5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Z0L2t2bWd0LmMKaW5kZXgg
ZmQxNjMzMzQyZTUzLi45YWNlMWY0ZmY5ZWIgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2d2dC9rdm1ndC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d2dC9rdm1ndC5jCkBA
IC0xMjUwLDYgKzEyNTAsOCBAQCBzdGF0aWMgaW50IGludGVsX3ZncHVfZ2V0X2lycV9jb3VudChz
dHJ1Y3QgaW50ZWxfdmdwdSAqdmdwdSwgaW50IHR5cGUpCiB7CiAJaWYgKHR5cGUgPT0gVkZJT19Q
Q0lfSU5UWF9JUlFfSU5ERVggfHwgdHlwZSA9PSBWRklPX1BDSV9NU0lfSVJRX0lOREVYKQogCQly
ZXR1cm4gMTsKKwllbHNlIGlmICh0eXBlIDwgVkZJT19QQ0lfTlVNX0lSUVMgKyB2Z3B1LT52ZGV2
Lm51bV9pcnFzKQorCQlyZXR1cm4gdmdwdS0+dmRldi5pcnFbdHlwZSAtIFZGSU9fUENJX05VTV9J
UlFTXS5jb3VudDsKIAogCXJldHVybiAwOwogfQpAQCAtMTI5Nyw3ICsxMjk5LDYwIEBAIHN0YXRp
YyBpbnQgaW50ZWxfdmdwdV9zZXRfbXNpX3RyaWdnZXIoc3RydWN0IGludGVsX3ZncHUgKnZncHUs
CiAJcmV0dXJuIDA7CiB9CiAKLXN0YXRpYyBpbnQgaW50ZWxfdmdwdV9zZXRfaXJxcyhzdHJ1Y3Qg
aW50ZWxfdmdwdSAqdmdwdSwgdTMyIGZsYWdzLAorc3RhdGljIGludCBpbnRlbF92Z3Vfc2V0X2Rp
c3BsYXlfaXJxX21hc2soc3RydWN0IGludGVsX3ZncHUgKnZncHUsCisJCXVuc2lnbmVkIGludCBp
bmRleCwgdW5zaWduZWQgaW50IHN0YXJ0LCB1bnNpZ25lZCBpbnQgY291bnQsCisJCXUzMiBmbGFn
cywgdm9pZCAqZGF0YSkKK3sKKwlpZiAoc3RhcnQgIT0gMCB8fCBjb3VudCA+IDIpCisJCXJldHVy
biAtRUlOVkFMOworCisJaWYgKGZsYWdzICYgVkZJT19JUlFfU0VUX0RBVEFfTk9ORSkKKwkJdmdw
dS0+dmRldi5kaXNwbGF5X2V2ZW50X21hc2sgfD0gMTsKKworCXJldHVybiAwOworfQorCitzdGF0
aWMgaW50IGludGVsX3ZndV9zZXRfZGlzcGxheV9pcnFfdW5tYXNrKHN0cnVjdCBpbnRlbF92Z3B1
ICp2Z3B1LAorCQl1bnNpZ25lZCBpbnQgaW5kZXgsIHVuc2lnbmVkIGludCBzdGFydCwgdW5zaWdu
ZWQgaW50IGNvdW50LAorCQl1MzIgZmxhZ3MsIHZvaWQgKmRhdGEpCit7CisJaWYgKHN0YXJ0ICE9
IDAgfHwgY291bnQgPiAyKQorCQlyZXR1cm4gLUVJTlZBTDsKKworCWlmIChmbGFncyAmIFZGSU9f
SVJRX1NFVF9EQVRBX05PTkUpCisJCXZncHUtPnZkZXYuZGlzcGxheV9ldmVudF9tYXNrICY9IDA7
CisKKwlyZXR1cm4gMDsKK30KKworc3RhdGljIGludCBpbnRlbF92Z3B1X3NldF9kaXNwbGF5X2V2
ZW50X3RyaWdnZXIoc3RydWN0IGludGVsX3ZncHUgKnZncHUsCisJCXVuc2lnbmVkIGludCBpbmRl
eCwgdW5zaWduZWQgaW50IHN0YXJ0LCB1bnNpZ25lZCBpbnQgY291bnQsCisJCXUzMiBmbGFncywg
dm9pZCAqZGF0YSkKK3sKKwlzdHJ1Y3QgZXZlbnRmZF9jdHggKnRyaWdnZXI7CisKKwlpZiAoZmxh
Z3MgJiBWRklPX0lSUV9TRVRfREFUQV9FVkVOVEZEKSB7CisJCWludCBmZCA9ICooaW50ICopZGF0
YTsKKworCQl0cmlnZ2VyID0gZXZlbnRmZF9jdHhfZmRnZXQoZmQpOworCQlpZiAoSVNfRVJSKHRy
aWdnZXIpKSB7CisJCQlndnRfdmdwdV9lcnIoImV2ZW50ZmRfY3R4X2ZkZ2V0IGZhaWxlZFxuIik7
CisJCQlyZXR1cm4gUFRSX0VSUih0cmlnZ2VyKTsKKwkJfQorCQl2Z3B1LT52ZGV2LnZibGFua190
cmlnZ2VyID0gdHJpZ2dlcjsKKwkJdmdwdS0+dmRldi5kaXNwbGF5X2V2ZW50X21hc2sgPSAwOwor
CX0gZWxzZSBpZiAoKGZsYWdzICYgVkZJT19JUlFfU0VUX0RBVEFfTk9ORSkgJiYgIWNvdW50KSB7
CisJCXRyaWdnZXIgPSB2Z3B1LT52ZGV2LnZibGFua190cmlnZ2VyOworCQlpZiAodHJpZ2dlcikg
eworCQkJZXZlbnRmZF9jdHhfcHV0KHRyaWdnZXIpOworCQkJdmdwdS0+dmRldi52YmxhbmtfdHJp
Z2dlciA9IE5VTEw7CisJCX0KKwl9CisKKwlyZXR1cm4gMDsKK30KKworaW50IGludGVsX3ZncHVf
c2V0X2lycXMoc3RydWN0IGludGVsX3ZncHUgKnZncHUsIHUzMiBmbGFncywKIAkJdW5zaWduZWQg
aW50IGluZGV4LCB1bnNpZ25lZCBpbnQgc3RhcnQsIHVuc2lnbmVkIGludCBjb3VudCwKIAkJdm9p
ZCAqZGF0YSkKIHsKQEAgLTEzMzAsNiArMTM4NSwzNSBAQCBzdGF0aWMgaW50IGludGVsX3ZncHVf
c2V0X2lycXMoc3RydWN0IGludGVsX3ZncHUgKnZncHUsIHUzMiBmbGFncywKIAkJCWJyZWFrOwog
CQl9CiAJCWJyZWFrOworCWRlZmF1bHQ6CisJeworCQlpbnQgaTsKKworCQlpZiAoaW5kZXggPj0g
VkZJT19QQ0lfTlVNX0lSUVMgKworCQkJCQl2Z3B1LT52ZGV2Lm51bV9pcnFzKQorCQkJcmV0dXJu
IC1FSU5WQUw7CisJCWluZGV4ID0KKwkJCWFycmF5X2luZGV4X25vc3BlYyhpbmRleCwKKwkJCQkJ
CVZGSU9fUENJX05VTV9JUlFTICsKKwkJCQkJCXZncHUtPnZkZXYubnVtX2lycXMpOworCisJCWkg
PSBpbmRleCAtIFZGSU9fUENJX05VTV9JUlFTOworCQlpZiAodmdwdS0+dmRldi5pcnFbaV0udHlw
ZSA9PSBWRklPX0lSUV9UWVBFX0dGWCAmJgorCQkgICAgdmdwdS0+dmRldi5pcnFbaV0uc3VidHlw
ZSA9PQorCQkgICAgVkZJT19JUlFfU1VCVFlQRV9HRlhfRElTUExBWV9JUlEpIHsKKwkJCXN3aXRj
aCAoZmxhZ3MgJiBWRklPX0lSUV9TRVRfQUNUSU9OX1RZUEVfTUFTSykgeworCQkJY2FzZSBWRklP
X0lSUV9TRVRfQUNUSU9OX01BU0s6CisJCQkJZnVuYyA9IGludGVsX3ZndV9zZXRfZGlzcGxheV9p
cnFfbWFzazsKKwkJCQlicmVhazsKKwkJCWNhc2UgVkZJT19JUlFfU0VUX0FDVElPTl9VTk1BU0s6
CisJCQkJZnVuYyA9IGludGVsX3ZndV9zZXRfZGlzcGxheV9pcnFfdW5tYXNrOworCQkJCWJyZWFr
OworCQkJY2FzZSBWRklPX0lSUV9TRVRfQUNUSU9OX1RSSUdHRVI6CisJCQkJZnVuYyA9IGludGVs
X3ZncHVfc2V0X2Rpc3BsYXlfZXZlbnRfdHJpZ2dlcjsKKwkJCQlicmVhazsKKwkJCX0KKwkJfQor
CX0KIAl9CiAKIAlpZiAoIWZ1bmMpCkBAIC0xMzYxLDcgKzE0NDUsNyBAQCBzdGF0aWMgbG9uZyBp
bnRlbF92Z3B1X2lvY3RsKHN0cnVjdCBtZGV2X2RldmljZSAqbWRldiwgdW5zaWduZWQgaW50IGNt
ZCwKIAkJaW5mby5mbGFncyB8PSBWRklPX0RFVklDRV9GTEFHU19SRVNFVDsKIAkJaW5mby5udW1f
cmVnaW9ucyA9IFZGSU9fUENJX05VTV9SRUdJT05TICsKIAkJCQl2Z3B1LT52ZGV2Lm51bV9yZWdp
b25zOwotCQlpbmZvLm51bV9pcnFzID0gVkZJT19QQ0lfTlVNX0lSUVM7CisJCWluZm8ubnVtX2ly
cXMgPSBWRklPX1BDSV9OVU1fSVJRUyArIHZncHUtPnZkZXYubnVtX2lycXM7CiAKIAkJcmV0dXJu
IGNvcHlfdG9fdXNlcigodm9pZCBfX3VzZXIgKilhcmcsICZpbmZvLCBtaW5zeikgPwogCQkJLUVG
QVVMVCA6IDA7CkBAIC0xNTIxLDMyICsxNjA1LDg4IEBAIHN0YXRpYyBsb25nIGludGVsX3ZncHVf
aW9jdGwoc3RydWN0IG1kZXZfZGV2aWNlICptZGV2LCB1bnNpZ25lZCBpbnQgY21kLAogCQkJLUVG
QVVMVCA6IDA7CiAJfSBlbHNlIGlmIChjbWQgPT0gVkZJT19ERVZJQ0VfR0VUX0lSUV9JTkZPKSB7
CiAJCXN0cnVjdCB2ZmlvX2lycV9pbmZvIGluZm87CisJCXN0cnVjdCB2ZmlvX2luZm9fY2FwIGNh
cHMgPSB7IC5idWYgPSBOVUxMLCAuc2l6ZSA9IDAgfTsKKwkJdW5zaWduZWQgaW50IGk7CisJCWlu
dCByZXQ7CiAKIAkJbWluc3ogPSBvZmZzZXRvZmVuZChzdHJ1Y3QgdmZpb19pcnFfaW5mbywgY291
bnQpOwogCiAJCWlmIChjb3B5X2Zyb21fdXNlcigmaW5mbywgKHZvaWQgX191c2VyICopYXJnLCBt
aW5zeikpCiAJCQlyZXR1cm4gLUVGQVVMVDsKIAotCQlpZiAoaW5mby5hcmdzeiA8IG1pbnN6IHx8
IGluZm8uaW5kZXggPj0gVkZJT19QQ0lfTlVNX0lSUVMpCisJCWlmIChpbmZvLmFyZ3N6IDwgbWlu
c3opCiAJCQlyZXR1cm4gLUVJTlZBTDsKIAogCQlzd2l0Y2ggKGluZm8uaW5kZXgpIHsKIAkJY2Fz
ZSBWRklPX1BDSV9JTlRYX0lSUV9JTkRFWDoKIAkJY2FzZSBWRklPX1BDSV9NU0lfSVJRX0lOREVY
OgorCQkJaW5mby5mbGFncyA9IFZGSU9fSVJRX0lORk9fRVZFTlRGRDsKIAkJCWJyZWFrOwotCQlk
ZWZhdWx0OgorCQljYXNlIFZGSU9fUENJX01TSVhfSVJRX0lOREVYOgorCQljYXNlIFZGSU9fUENJ
X0VSUl9JUlFfSU5ERVg6CisJCWNhc2UgVkZJT19QQ0lfUkVRX0lSUV9JTkRFWDoKIAkJCXJldHVy
biAtRUlOVkFMOwotCQl9CisJCWRlZmF1bHQ6CisJCXsKKwkJCXN0cnVjdCB2ZmlvX2lycV9pbmZv
X2NhcF90eXBlIGNhcF90eXBlID0geworCQkJCS5oZWFkZXIuaWQgPSBWRklPX0lSUV9JTkZPX0NB
UF9UWVBFLAorCQkJCS5oZWFkZXIudmVyc2lvbiA9IDEgfTsKIAotCQlpbmZvLmZsYWdzID0gVkZJ
T19JUlFfSU5GT19FVkVOVEZEOworCQkJaWYgKGluZm8uaW5kZXggPj0gVkZJT19QQ0lfTlVNX0lS
UVMgKworCQkJCQl2Z3B1LT52ZGV2Lm51bV9pcnFzKQorCQkJCXJldHVybiAtRUlOVkFMOworCQkJ
aW5mby5pbmRleCA9CisJCQkJYXJyYXlfaW5kZXhfbm9zcGVjKGluZm8uaW5kZXgsCisJCQkJCQlW
RklPX1BDSV9OVU1fSVJRUyArCisJCQkJCQl2Z3B1LT52ZGV2Lm51bV9pcnFzKTsKKworCQkJaSA9
IGluZm8uaW5kZXggLSBWRklPX1BDSV9OVU1fSVJRUzsKKworCQkJaW5mby5mbGFncyA9IHZncHUt
PnZkZXYuaXJxW2ldLmZsYWdzOworCQkJY2FwX3R5cGUudHlwZSA9IHZncHUtPnZkZXYuaXJxW2ld
LnR5cGU7CisJCQljYXBfdHlwZS5zdWJ0eXBlID0gdmdwdS0+dmRldi5pcnFbaV0uc3VidHlwZTsK
KworCQkJcmV0ID0gdmZpb19pbmZvX2FkZF9jYXBhYmlsaXR5KCZjYXBzLAorCQkJCQkJJmNhcF90
eXBlLmhlYWRlciwKKwkJCQkJCXNpemVvZihjYXBfdHlwZSkpOworCQkJaWYgKHJldCkKKwkJCQly
ZXR1cm4gcmV0OworCisJCQlpZiAodmdwdS0+dmRldi5pcnFbaV0ub3BzLT5hZGRfY2FwYWJpbGl0
eSkgeworCQkJCXJldCA9IHZncHUtPnZkZXYuaXJxW2ldLm9wcy0+YWRkX2NhcGFiaWxpdHkodmdw
dSwKKwkJCQkJCQkJCSAgICAmY2Fwcyk7CisJCQkJaWYgKHJldCkKKwkJCQkJcmV0dXJuIHJldDsK
KwkJCX0KKwkJfQorCQl9CiAKIAkJaW5mby5jb3VudCA9IGludGVsX3ZncHVfZ2V0X2lycV9jb3Vu
dCh2Z3B1LCBpbmZvLmluZGV4KTsKIAogCQlpZiAoaW5mby5pbmRleCA9PSBWRklPX1BDSV9JTlRY
X0lSUV9JTkRFWCkKIAkJCWluZm8uZmxhZ3MgfD0gKFZGSU9fSVJRX0lORk9fTUFTS0FCTEUgfAog
CQkJCSAgICAgICBWRklPX0lSUV9JTkZPX0FVVE9NQVNLRUQpOwotCQllbHNlCi0JCQlpbmZvLmZs
YWdzIHw9IFZGSU9fSVJRX0lORk9fTk9SRVNJWkU7CisKKwkJaWYgKGNhcHMuc2l6ZSkgeworCQkJ
aW5mby5mbGFncyB8PSBWRklPX0lSUV9JTkZPX0ZMQUdfQ0FQUzsKKwkJCWlmIChpbmZvLmFyZ3N6
IDwgc2l6ZW9mKGluZm8pICsgY2Fwcy5zaXplKSB7CisJCQkJaW5mby5hcmdzeiA9IHNpemVvZihp
bmZvKSArIGNhcHMuc2l6ZTsKKwkJCQlpbmZvLmNhcF9vZmZzZXQgPSAwOworCQkJfSBlbHNlIHsK
KwkJCQl2ZmlvX2luZm9fY2FwX3NoaWZ0KCZjYXBzLCBzaXplb2YoaW5mbykpOworCQkJCWlmIChj
b3B5X3RvX3VzZXIoKHZvaWQgX191c2VyICopYXJnICsKKwkJCQkJCSAgc2l6ZW9mKGluZm8pLCBj
YXBzLmJ1ZiwKKwkJCQkJCSAgY2Fwcy5zaXplKSkgeworCQkJCQlrZnJlZShjYXBzLmJ1Zik7CisJ
CQkJCXJldHVybiAtRUZBVUxUOworCQkJCX0KKwkJCQlpbmZvLmNhcF9vZmZzZXQgPSBzaXplb2Yo
aW5mbyk7CisJCQkJaWYgKG9mZnNldG9mZW5kKHN0cnVjdCB2ZmlvX2lycV9pbmZvLCBjYXBfb2Zm
c2V0KSA+IG1pbnN6KQorCQkJCQltaW5zeiA9IG9mZnNldG9mZW5kKHN0cnVjdCB2ZmlvX2lycV9p
bmZvLCBjYXBfb2Zmc2V0KTsKKwkJCX0KKworCQkJa2ZyZWUoY2Fwcy5idWYpOworCQl9CiAKIAkJ
cmV0dXJuIGNvcHlfdG9fdXNlcigodm9pZCBfX3VzZXIgKilhcmcsICZpbmZvLCBtaW5zeikgPwog
CQkJLUVGQVVMVCA6IDA7CkBAIC0xNTY1LDcgKzE3MDUsOCBAQCBzdGF0aWMgbG9uZyBpbnRlbF92
Z3B1X2lvY3RsKHN0cnVjdCBtZGV2X2RldmljZSAqbWRldiwgdW5zaWduZWQgaW50IGNtZCwKIAkJ
CWludCBtYXggPSBpbnRlbF92Z3B1X2dldF9pcnFfY291bnQodmdwdSwgaGRyLmluZGV4KTsKIAog
CQkJcmV0ID0gdmZpb19zZXRfaXJxc192YWxpZGF0ZV9hbmRfcHJlcGFyZSgmaGRyLCBtYXgsCi0J
CQkJCQlWRklPX1BDSV9OVU1fSVJRUywgJmRhdGFfc2l6ZSk7CisJCQkJCVZGSU9fUENJX05VTV9J
UlFTICsgdmdwdS0+dmRldi5udW1faXJxcywKKwkJCQkJCQkJICZkYXRhX3NpemUpOwogCQkJaWYg
KHJldCkgewogCQkJCWd2dF92Z3B1X2VycigiaW50ZWw6dmZpb19zZXRfaXJxc192YWxpZGF0ZV9h
bmRfcHJlcGFyZSBmYWlsZWRcbiIpOwogCQkJCXJldHVybiAtRUlOVkFMOwotLSAKMi4xNy4xCgpf
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwppbnRlbC1ndnQt
ZGV2IG1haWxpbmcgbGlzdAppbnRlbC1ndnQtZGV2QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRw
czovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWd2dC1kZXY=
