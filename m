Return-Path: <intel-gvt-dev-bounces@lists.freedesktop.org>
X-Original-To: lists+intel-gvt-dev@lfdr.de
Delivered-To: lists+intel-gvt-dev@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id A362E28F64
	for <lists+intel-gvt-dev@lfdr.de>; Fri, 24 May 2019 05:05:26 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 4F0BA6E047;
	Fri, 24 May 2019 03:05:25 +0000 (UTC)
X-Original-To: intel-gvt-dev@lists.freedesktop.org
Delivered-To: intel-gvt-dev@lists.freedesktop.org
Received: from mga17.intel.com (mga17.intel.com [192.55.52.151])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 792746E047
 for <intel-gvt-dev@lists.freedesktop.org>;
 Fri, 24 May 2019 03:05:24 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga004.jf.intel.com ([10.7.209.38])
 by fmsmga107.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 23 May 2019 20:05:24 -0700
X-ExtLoop1: 1
Received: from gvt.bj.intel.com ([10.238.158.187])
 by orsmga004.jf.intel.com with ESMTP; 23 May 2019 20:05:22 -0700
From: Tina Zhang <tina.zhang@intel.com>
To: zhenyuw@linux.intel.com
Subject: [PATCH] drm/i915/gvt: Pin vgpu dma address before using
Date: Fri, 24 May 2019 10:59:54 +0800
Message-Id: <20190524025954.3031-1-tina.zhang@intel.com>
X-Mailer: git-send-email 2.17.1
X-BeenThere: intel-gvt-dev@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: "Intel GVT \(Graphics Virtualization\) development list"
 <intel-gvt-dev.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/intel-gvt-dev>, 
 <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/intel-gvt-dev>
List-Post: <mailto:intel-gvt-dev@lists.freedesktop.org>
List-Help: <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/intel-gvt-dev>, 
 <mailto:intel-gvt-dev-request@lists.freedesktop.org?subject=subscribe>
Cc: hang.yuan@intel.com, intel-gvt-dev@lists.freedesktop.org,
 Tina Zhang <tina.zhang@intel.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: intel-gvt-dev-bounces@lists.freedesktop.org
Sender: "intel-gvt-dev" <intel-gvt-dev-bounces@lists.freedesktop.org>

RG1hLWJ1ZiBkaXNwbGF5IHVzZXMgdGhlIHZncHUgZG1hIGFkZHJlc3Mgc2F2ZWQgaW4gdGhlIGd1
ZXN0IHBhcnQgR0dUVAp0YWJsZSB3aGljaCBpcyB1cGRhdGVkIGJ5IHZDUFUgdGhyZWFkLiBJbiBo
b3N0IHNpZGUsIHdoZW4gdGhlIGRtYQphZGRyZXNzIGlzIHVzZWQgYnkgcWVtdSB1aSB0aHJlYWQs
IGd2dC1nIG11c3QgbWFrZSBzdXJlIHRoZSBkbWEgYWRkcmVzcwppcyB2YWxpZGF0ZWQgYmVmb3Jl
IGxldHRpbmcgaXQgZ28gdG8gdGhlIEhXLiBJbnZhbGlkIGd1ZXN0IGRtYSBhZGRyZXNzCndpbGwg
ZWFzaWx5IGNhdXNlIERNQSBmYXVsdCBhbmQgbWFrZSBHUFUgaGFuZy4KClNpZ25lZC1vZmYtYnk6
IFRpbmEgWmhhbmcgPHRpbmEuemhhbmdAaW50ZWwuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9p
OTE1L2d2dC9kbWFidWYuYyAgICB8IDU5ICsrKysrKysrKysrKysrKysrKysrKysrKysrLS0KIGRy
aXZlcnMvZ3B1L2RybS9pOTE1L2d2dC9oeXBlcmNhbGwuaCB8ICAyICsKIGRyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2d2dC9rdm1ndC5jICAgICB8IDI3ICsrKysrKysrKysrKysKIGRyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2d2dC9tcHQuaCAgICAgICB8IDE0ICsrKysrKysKIDQgZmlsZXMgY2hhbmdlZCwgOTkg
aW5zZXJ0aW9ucygrKSwgMyBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9ndnQvZG1hYnVmLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQvZG1hYnVmLmMK
aW5kZXggYjZkOTMxNzViZGRmLi45ZGI0MzI4ZTk3MzIgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L2d2dC9kbWFidWYuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQvZG1h
YnVmLmMKQEAgLTM2LDEwICszNiwyOCBAQAogCiAjZGVmaW5lIEdFTjhfREVDT0RFX1BURShwdGUp
IChwdGUgJiBHRU5NQVNLX1VMTCg2MywgMTIpKQogCitzdGF0aWMgaW50IHZncHVfcGluX2RtYV9h
ZGRyZXNzKHN0cnVjdCBpbnRlbF92Z3B1ICp2Z3B1LCB1bnNpZ25lZCBsb25nIHNpemUsCisJCWRt
YV9hZGRyX3QgZG1hX2FkZHIpCit7CisJaW50IHJldCA9IDA7CisKKwlpZiAoaW50ZWxfZ3Z0X2h5
cGVydmlzb3JfZG1hX2dldF9ndWVzdF9wYWdlKHZncHUsIGRtYV9hZGRyKSkKKwkJcmV0ID0gLUVO
T01FTTsKKworCXJldHVybiByZXQ7Cit9CisKK3N0YXRpYyB2b2lkIHZncHVfdW5waW5fZG1hX2Fk
ZHJlc3Moc3RydWN0IGludGVsX3ZncHUgKnZncHUsCisJCQkJICBkbWFfYWRkcl90IGRtYV9hZGRy
KQoreworCWludGVsX2d2dF9oeXBlcnZpc29yX2RtYV91bm1hcF9ndWVzdF9wYWdlKHZncHUsIGRt
YV9hZGRyKTsKK30KKwogc3RhdGljIGludCB2Z3B1X2dlbV9nZXRfcGFnZXMoCiAJCXN0cnVjdCBk
cm1faTkxNV9nZW1fb2JqZWN0ICpvYmopCiB7CiAJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRl
dl9wcml2ID0gdG9faTkxNShvYmotPmJhc2UuZGV2KTsKKwlzdHJ1Y3QgaW50ZWxfdmdwdSAqdmdw
dTsKIAlzdHJ1Y3Qgc2dfdGFibGUgKnN0OwogCXN0cnVjdCBzY2F0dGVybGlzdCAqc2c7CiAJaW50
IGksIHJldDsKQEAgLTUwLDYgKzY4LDEwIEBAIHN0YXRpYyBpbnQgdmdwdV9nZW1fZ2V0X3BhZ2Vz
KAogCWlmIChXQVJOX09OKCFmYl9pbmZvKSkKIAkJcmV0dXJuIC1FTk9ERVY7CiAKKwl2Z3B1ID0g
ZmJfaW5mby0+b2JqLT52Z3B1OworCWlmIChXQVJOX09OKCF2Z3B1KSkKKwkJcmV0dXJuIC1FTk9E
RVY7CisKIAlzdCA9IGttYWxsb2Moc2l6ZW9mKCpzdCksIEdGUF9LRVJORUwpOwogCWlmICh1bmxp
a2VseSghc3QpKQogCQlyZXR1cm4gLUVOT01FTTsKQEAgLTYyLDIxICs4NCw1MSBAQCBzdGF0aWMg
aW50IHZncHVfZ2VtX2dldF9wYWdlcygKIAlndHRfZW50cmllcyA9IChnZW44X3B0ZV90IF9faW9t
ZW0gKilkZXZfcHJpdi0+Z2d0dC5nc20gKwogCQkoZmJfaW5mby0+c3RhcnQgPj4gUEFHRV9TSElG
VCk7CiAJZm9yX2VhY2hfc2coc3QtPnNnbCwgc2csIGZiX2luZm8tPnNpemUsIGkpIHsKKwkJZG1h
X2FkZHJfdCBkbWFfYWRkciA9CisJCQlHRU44X0RFQ09ERV9QVEUocmVhZHEoJmd0dF9lbnRyaWVz
W2ldKSk7CisJCWlmICh2Z3B1X3Bpbl9kbWFfYWRkcmVzcyh2Z3B1LCBQQUdFX1NJWkUsIGRtYV9h
ZGRyKSkgeworCQkJcmV0ID0gLUVOT01FTTsKKwkJCWdvdG8gb3V0OworCQl9CiAJCXNnLT5vZmZz
ZXQgPSAwOwogCQlzZy0+bGVuZ3RoID0gUEFHRV9TSVpFOwotCQlzZ19kbWFfYWRkcmVzcyhzZykg
PQotCQkJR0VOOF9ERUNPREVfUFRFKHJlYWRxKCZndHRfZW50cmllc1tpXSkpOwogCQlzZ19kbWFf
bGVuKHNnKSA9IFBBR0VfU0laRTsKKwkJc2dfZG1hX2FkZHJlc3Moc2cpID0gZG1hX2FkZHI7CiAJ
fQogCiAJX19pOTE1X2dlbV9vYmplY3Rfc2V0X3BhZ2VzKG9iaiwgc3QsIFBBR0VfU0laRSk7Citv
dXQ6CisJaWYgKHJldCkgeworCQlkbWFfYWRkcl90IGRtYV9hZGRyOwogCi0JcmV0dXJuIDA7CisJ
CWZvcl9lYWNoX3NnKHN0LT5zZ2wsIHNnLCBmYl9pbmZvLT5zaXplLCBpKSB7CisJCQlkbWFfYWRk
ciA9IHNnX2RtYV9hZGRyZXNzKHNnKTsKKwkJCWlmIChkbWFfYWRkcikKKwkJCQl2Z3B1X3VucGlu
X2RtYV9hZGRyZXNzKHZncHUsIGRtYV9hZGRyKTsKKwkJfQorCQlzZ19mcmVlX3RhYmxlKHN0KTsK
KwkJa2ZyZWUoc3QpOworCX0KKworCXJldHVybiByZXQ7CiB9CiAKIHN0YXRpYyB2b2lkIHZncHVf
Z2VtX3B1dF9wYWdlcyhzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqLAogCQlzdHJ1Y3Qg
c2dfdGFibGUgKnBhZ2VzKQogeworCXN0cnVjdCBzY2F0dGVybGlzdCAqc2c7CisKKwlpZiAob2Jq
LT5iYXNlLmRtYV9idWYpIHsKKwkJc3RydWN0IGludGVsX3ZncHVfZmJfaW5mbyAqZmJfaW5mbyA9
IG9iai0+Z3Z0X2luZm87CisJCXN0cnVjdCBpbnRlbF92Z3B1X2RtYWJ1Zl9vYmogKm9iaiA9IGZi
X2luZm8tPm9iajsKKwkJc3RydWN0IGludGVsX3ZncHUgKnZncHUgPSBvYmotPnZncHU7CisJCWlu
dCBpOworCisJCWZvcl9lYWNoX3NnKHBhZ2VzLT5zZ2wsIHNnLCBmYl9pbmZvLT5zaXplLCBpKQor
CQkJdmdwdV91bnBpbl9kbWFfYWRkcmVzcyh2Z3B1LAorCQkJCQkgICAgICAgc2dfZG1hX2FkZHJl
c3Moc2cpKTsKKwl9CisKIAlzZ19mcmVlX3RhYmxlKHBhZ2VzKTsKIAlrZnJlZShwYWdlcyk7CiB9
CkBAIC0xMDgsNiArMTYwLDcgQEAgc3RhdGljIHZvaWQgZG1hYnVmX2dlbV9vYmplY3RfZnJlZShz
dHJ1Y3Qga3JlZiAqa3JlZikKIAkJa2ZyZWUob2JqLT5pbmZvKTsKIAkJa2ZyZWUob2JqKTsKIAl9
CisKIH0KIAogCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQvaHlwZXJjYWxs
LmggYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQvaHlwZXJjYWxsLmgKaW5kZXggNDg2MmZiMTI3
NzhlLi43NTZhZGNjNzE2MDIgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d2dC9o
eXBlcmNhbGwuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQvaHlwZXJjYWxsLmgKQEAg
LTYyLDYgKzYyLDggQEAgc3RydWN0IGludGVsX2d2dF9tcHQgewogCQkJCSAgdW5zaWduZWQgbG9u
ZyBzaXplLCBkbWFfYWRkcl90ICpkbWFfYWRkcik7CiAJdm9pZCAoKmRtYV91bm1hcF9ndWVzdF9w
YWdlKSh1bnNpZ25lZCBsb25nIGhhbmRsZSwgZG1hX2FkZHJfdCBkbWFfYWRkcik7CiAKKwlpbnQg
KCpkbWFfZ2V0X2d1ZXN0X3BhZ2UpKHVuc2lnbmVkIGxvbmcgaGFuZGxlLCBkbWFfYWRkcl90IGRt
YV9hZGRyKTsKKwogCWludCAoKm1hcF9nZm5fdG9fbWZuKSh1bnNpZ25lZCBsb25nIGhhbmRsZSwg
dW5zaWduZWQgbG9uZyBnZm4sCiAJCQkgICAgICB1bnNpZ25lZCBsb25nIG1mbiwgdW5zaWduZWQg
aW50IG5yLCBib29sIG1hcCk7CiAJaW50ICgqc2V0X3RyYXBfYXJlYSkodW5zaWduZWQgbG9uZyBo
YW5kbGUsIHU2NCBzdGFydCwgdTY0IGVuZCwKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2d2dC9rdm1ndC5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Z0L2t2bWd0LmMKaW5kZXgg
MjkxMTgxODI4NmE1Li5lMzNmMjQwZWE5ZDYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2d2dC9rdm1ndC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d2dC9rdm1ndC5jCkBA
IC0yMTMsNiArMjEzLDEwIEBAIHN0YXRpYyB2b2lkIGd2dF9kbWFfdW5tYXBfcGFnZShzdHJ1Y3Qg
aW50ZWxfdmdwdSAqdmdwdSwgdW5zaWduZWQgbG9uZyBnZm4sCiAJc3RydWN0IGRldmljZSAqZGV2
ID0gJnZncHUtPmd2dC0+ZGV2X3ByaXYtPmRybS5wZGV2LT5kZXY7CiAKIAlkbWFfdW5tYXBfcGFn
ZShkZXYsIGRtYV9hZGRyLCBzaXplLCBQQ0lfRE1BX0JJRElSRUNUSU9OQUwpOworCWlmIChkbWFf
bWFwcGluZ19lcnJvcihkZXYsIGRtYV9hZGRyKSkgeworCQlndnRfdmdwdV9lcnIoIkRNQSB1bm1h
cHBpbmcgZmFpbGVkIGZvciBkbWFfYWRkciAweCVsbHhcbiIsCisJCQkgICAgIGRtYV9hZGRyKTsK
Kwl9CiAJZ3Z0X3VucGluX2d1ZXN0X3BhZ2UodmdwdSwgZ2ZuLCBzaXplKTsKIH0KIApAQCAtMTk2
NCw2ICsxOTY4LDI4IEBAIHN0YXRpYyBpbnQga3ZtZ3RfZG1hX21hcF9ndWVzdF9wYWdlKHVuc2ln
bmVkIGxvbmcgaGFuZGxlLCB1bnNpZ25lZCBsb25nIGdmbiwKIAlyZXR1cm4gcmV0OwogfQogCitz
dGF0aWMgaW50IGt2bWd0X2RtYV9nZXRfZ3Vlc3RfcGFnZSh1bnNpZ25lZCBsb25nIGhhbmRsZSwg
ZG1hX2FkZHJfdCBkbWFfYWRkcikKK3sKKwlzdHJ1Y3Qga3ZtZ3RfZ3Vlc3RfaW5mbyAqaW5mbzsK
KwlzdHJ1Y3QgZ3Z0X2RtYSAqZW50cnk7CisJaW50IHJldCA9IDA7CisKKwlpZiAoIWhhbmRsZV92
YWxpZChoYW5kbGUpKQorCQlyZXR1cm4gLUVOT0RFVjsKKworCWluZm8gPSAoc3RydWN0IGt2bWd0
X2d1ZXN0X2luZm8gKiloYW5kbGU7CisKKwltdXRleF9sb2NrKCZpbmZvLT52Z3B1LT52ZGV2LmNh
Y2hlX2xvY2spOworCWVudHJ5ID0gX19ndnRfY2FjaGVfZmluZF9kbWFfYWRkcihpbmZvLT52Z3B1
LCBkbWFfYWRkcik7CisJaWYgKGVudHJ5KQorCQlrcmVmX2dldCgmZW50cnktPnJlZik7CisJZWxz
ZQorCQlyZXQgPSAtRU5PTUVNOworCW11dGV4X3VubG9jaygmaW5mby0+dmdwdS0+dmRldi5jYWNo
ZV9sb2NrKTsKKworCXJldHVybiByZXQ7Cit9CisKIHN0YXRpYyB2b2lkIF9fZ3Z0X2RtYV9yZWxl
YXNlKHN0cnVjdCBrcmVmICpyZWYpCiB7CiAJc3RydWN0IGd2dF9kbWEgKmVudHJ5ID0gY29udGFp
bmVyX29mKHJlZiwgdHlwZW9mKCplbnRyeSksIHJlZik7CkBAIC0yMDc1LDYgKzIxMDEsNyBAQCBz
dGF0aWMgc3RydWN0IGludGVsX2d2dF9tcHQga3ZtZ3RfbXB0ID0gewogCS5nZm5fdG9fbWZuID0g
a3ZtZ3RfZ2ZuX3RvX3BmbiwKIAkuZG1hX21hcF9ndWVzdF9wYWdlID0ga3ZtZ3RfZG1hX21hcF9n
dWVzdF9wYWdlLAogCS5kbWFfdW5tYXBfZ3Vlc3RfcGFnZSA9IGt2bWd0X2RtYV91bm1hcF9ndWVz
dF9wYWdlLAorCS5kbWFfZ2V0X2d1ZXN0X3BhZ2UgPSBrdm1ndF9kbWFfZ2V0X2d1ZXN0X3BhZ2Us
CiAJLnNldF9vcHJlZ2lvbiA9IGt2bWd0X3NldF9vcHJlZ2lvbiwKIAkuc2V0X2VkaWQgPSBrdm1n
dF9zZXRfZWRpZCwKIAkuZ2V0X3ZmaW9fZGV2aWNlID0ga3ZtZ3RfZ2V0X3ZmaW9fZGV2aWNlLApk
aWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3Z0L21wdC5oIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ3Z0L21wdC5oCmluZGV4IDBmOTQ0MDEyODEyMy4uNGU5MzkxYTUyMDk4IDEwMDY0
NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndnQvbXB0LmgKKysrIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ3Z0L21wdC5oCkBAIC0yNTQsNiArMjU0LDIwIEBAIHN0YXRpYyBpbmxpbmUgdm9p
ZCBpbnRlbF9ndnRfaHlwZXJ2aXNvcl9kbWFfdW5tYXBfZ3Vlc3RfcGFnZSgKIAlpbnRlbF9ndnRf
aG9zdC5tcHQtPmRtYV91bm1hcF9ndWVzdF9wYWdlKHZncHUtPmhhbmRsZSwgZG1hX2FkZHIpOwog
fQogCisvKioKKyAqIGludGVsX2d2dF9oeXBlcnZpc29yX2RtYV9nZXRfZ3Vlc3RfcGFnZSAtIGdl
dCBndWVzdCBkbWEgbWFwIGFkZHIKKyAqIEB2Z3B1OiBhIHZHUFUKKyAqIEBkbWFfYWRkcjogZ3Vl
c3QgZG1hIGFkZHIKKyAqCisgKiBSZXR1cm5zOgorICogMCBvbiBzdWNjZXNzLCBuZWdhdGl2ZSBl
cnJvciBjb2RlIGlmIGZhaWxlZC4KKyAqLworc3RhdGljIGlubGluZSBpbnQgaW50ZWxfZ3Z0X2h5
cGVydmlzb3JfZG1hX2dldF9ndWVzdF9wYWdlKAorCQlzdHJ1Y3QgaW50ZWxfdmdwdSAqdmdwdSwg
ZG1hX2FkZHJfdCBkbWFfYWRkcikKK3sKKwlyZXR1cm4gaW50ZWxfZ3Z0X2hvc3QubXB0LT5kbWFf
Z2V0X2d1ZXN0X3BhZ2UodmdwdS0+aGFuZGxlLCBkbWFfYWRkcik7Cit9CisKIC8qKgogICogaW50
ZWxfZ3Z0X2h5cGVydmlzb3JfbWFwX2dmbl90b19tZm4gLSBtYXAgYSBHRk4gcmVnaW9uIHRvIE1G
TgogICogQHZncHU6IGEgdkdQVQotLSAKMi4xNy4xCgpfX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fXwppbnRlbC1ndnQtZGV2IG1haWxpbmcgbGlzdAppbnRlbC1n
dnQtZGV2QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9y
Zy9tYWlsbWFuL2xpc3RpbmZvL2ludGVsLWd2dC1kZXY=
